<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Artivive Studio </title>
    
    <style>
        /* style.css content starts here */

        :root {
            --bg-dark: #1a1a1a;
            --bg-medium: #2a2a2a;
            --bg-light: #3a3a3a;
            --text-light: #f0f0f0;
            --text-medium: #b0b0b0;
            --accent-color: #007bff; /* Biru cerah */
            --accent-hover: #0056b3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --border-color: #4a4a4a;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --warning-color: #ffc107; /* Kuning untuk peringatan */
            --discount-color: #00ff00; /* Hijau terang untuk diskon */
            --old-price-color: #888; /* Warna abu-abu untuk harga lama */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
        }

        .container {
            background-color: var(--bg-medium);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 20px var(--shadow-color);
            width: 100%;
            max-width: 900px;
            margin: 30px auto;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        header {
            background-color: var(--bg-light);
            width: 100%;
            padding: 15px 0;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 20px;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap; /* Untuk responsif */
        }

        nav a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        nav a:hover, nav a.active {
            background-color: var(--accent-color);
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-medium);
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        input[type="datetime-local"], /* Tambahan untuk datetime-local */
        textarea,
        select {
            width: calc(100% - 22px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-light);
            color: var(--text-light);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        input[type="number"]:focus,
        input[type="datetime-local"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        button {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }

        .product-card {
            background-color: var(--bg-light);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow-color);
        }

        .product-card img {
            max-width: 100%;
            height: 180px;
            object-fit: contain;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .product-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .product-card p {
            color: var(--text-medium);
            margin-bottom: 15px;
        }

        .product-card button {
            width: 100%;
            margin-top: auto; /* Push button to bottom */
        }

        /* Harga Diskon */
        .price-info {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--old-price-color);
            margin-right: 8px;
            font-size: 0.9em;
        }

        .discounted-price {
            color: var(--discount-color);
            font-weight: bold;
        }

        .discount-tag {
            background-color: var(--success-color);
            color: white;
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }


        /* Admin Specific */
        .admin-section h3 {
            text-align: left;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            color: var(--accent-color);
        }

        .code-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-medium);
        }

        .code-list-item:last-child {
            border-bottom: none;
        }

        .code-list-item .status {
            font-weight: bold;
            color: var(--success-color);
        }

        .code-list-item .status.used {
            color: var(--error-color);
        }

        /* User Management Table */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .user-table th {
            background-color: var(--bg-light);
            color: var(--accent-color);
            font-weight: bold;
        }

        .user-table tr:hover {
            background-color: var(--bg-light);
        }

        .user-table .admin-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .user-table .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 0.9em;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .user-table .make-admin-btn {
            background-color: var(--success-color);
        }

        .user-table .remove-admin-btn {
            background-color: var(--warning-color);
        }

        .user-table .delete-user-btn {
            background-color: var(--error-color);
        }

        .user-table .action-btn:hover {
            opacity: 0.9;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 15px;
                padding: 20px;
            }
            nav {
                flex-direction: column;
                gap: 10px;
            }
            nav a {
                width: fit-content;
                margin: 0 auto;
            }
            
            .user-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* --- Custom Pop-up (Modal) --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s forwards;
        }

        .modal-content {
            background-color: var(--bg-medium);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            animation: slideIn 0.3s forwards;
            position: relative; /* For close button positioning */
        }

        .modal-content.error {
            border-color: var(--error-color);
        }

        .modal-content.success {
            border-color: var(--success-color);
        }

        .modal-content.warning {
            border-color: var(--warning-color);
        }

        .modal h2 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .modal p {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 1.1em;
            word-break: break-all; /* For long codes/IDs */
        }

        .modal strong {
            color: var(--text-light);
            font-size: 1.2em;
            background-color: var(--bg-light);
            padding: 8px 15px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px 0;
            border: 1px dashed var(--border-color);
        }

        .modal button {
            margin: 10px 5px;
        }

        .close-button {
            color: var(--text-medium);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--error-color);
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* --- Live Sale Notification --- */
        .sale-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: var(--bg-light);
            color: var(--text-light);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 999;
            display: flex;
            align-items: center;
            opacity: 0; /* Hidden by default */
            transform: translateX(-100%); /* Start off-screen */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .sale-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .sale-notification p {
            margin: 0;
            font-size: 1.05em;
            display: flex;
            align-items: center;
        }

        .sale-notification .sale-icon {
            font-size: 1.5em;
            margin-right: 10px;
            color: var(--success-color); /* Atau warna lain yang menarik */
        }

        /* --- Top Products List --- */
        .top-products-list {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 30px;
        }

        .top-products-list h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .top-products-list ol {
            list-style: none; /* Remove default numbering */
            padding: 0;
            counter-reset: top-product-counter; /* Initialize counter */
        }

        .top-products-list li {
            counter-increment: top-product-counter; /* Increment counter for each list item */
            background-color: var(--bg-light);
            margin-bottom: 10px;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            padding-left: 50px; /* Make space for the number */
        }

        .top-products-list li::before {
            content: counter(top-product-counter);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--accent-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .top-products-list li strong {
            color: var(--text-light);
            font-size: 1.1em;
        }

        .top-products-list li span {
            color: var(--text-medium);
            margin-left: auto; /* Push count to the right */
            font-weight: bold;
        }

        /* --- Discount Countdown --- */
        .discount-countdown-section {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--bg-light);
            border-radius: 8px;
            box-shadow: 0 4px 10px var(--shadow-color);
            text-align: center;
        }

        .countdown-timer {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--discount-color);
            margin-top: 15px;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .countdown-timer.expired {
            color: var(--error-color);
        }

        .countdown-timer.upcoming {
            color: var(--warning-color);
        }

        /* --- Maintenance Mode Overlay --- */
        .maintenance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Darker overlay */
            color: var(--text-light);
            z-index: 2000; /* Higher than other modals */
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow-y: auto; /* Enable scrolling */
        }

        .maintenance-content {
            background-color: var(--bg-medium);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px var(--shadow-color);
            max-width: 600px;
            border: 2px solid var(--warning-color);
            margin: 50px 0; /* Add margin for scrolling */
        }

        .maintenance-content h1 {
            color: var(--warning-color);
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .maintenance-content p {
            font-size: 1.2em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .maintenance-countdown {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--warning-color);
            margin: 20px 0;
        }

        .maintenance-reason {
            background-color: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--warning-color);
        }

        /* Hidden Admin Login */
        .hidden-admin-login {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 3px;
        }

        .hidden-admin-login:hover {
            color: rgba(255, 255, 255, 0.8);
            background-color: rgba(0, 0, 0, 0.8);
        }

        .admin-secret-login {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-dark);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            z-index: 3000;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .admin-secret-login h2 {
            color: var(--warning-color);
            margin-top: 0;
            text-align: center;
        }

        .admin-secret-login .form-group {
            margin-bottom: 15px;
        }

        .admin-secret-login input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 5px;
        }

        .admin-secret-login button {
            width: 100%;
            padding: 10px;
            background-color: var(--warning-color);
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-secret-login button:hover {
            background-color: #e0a800;
        }

        /* style.css content ends here */
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="#" onclick="showPage('home')">Beranda</a>
            <a href="#" onclick="showPage('redeem')">Tukar ID Pesanan</a>
            <span id="authLinks">
                <a href="#" onclick="showPage('login')">Login</a>
                <a href="#" onclick="showPage('register')">Register</a>
            </span>
            <span id="loggedInLinks" style="display:none;">
                <a href="#" onclick="showPage('admin')">Admin Panel</a>
                <a href="#" onclick="logoutUser()">Logout</a>
            </span>
        </nav>
    </header>

    <main class="container" id="appContent">
    </main>

    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <button id="modalCopyButton" style="display:none;"></button>
            <button onclick="closeModal()">Tutup</button>
        </div>
    </div>

    <div id="saleNotification" class="sale-notification">
        <p><span class="sale-icon">üí∞</span> <span id="saleMessage"></span></p>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content warning">
            <span class="close-button" onclick="hideConfirmation()">&times;</span>
            <h2>Konfirmasi Pembelian</h2>
            <p id="confirmationMessage"></p>
            <button id="confirmPurchaseBtn">Ya, Beli</button>
            <button id="cancelPurchaseBtn">Batal</button>
        </div>
    </div>

    <div id="maintenanceOverlay" class="maintenance-overlay" style="display:none;">
        <div class="maintenance-content">
            <h1>üöß Sedang Dalam Pemeliharaan üöß</h1>
            <div id="maintenanceCountdown" class="maintenance-countdown"></div>
            <div id="maintenanceReason" class="maintenance-reason"></div>
            <p>Kami sedang melakukan perbaikan dan pembaruan untuk meningkatkan pengalaman Anda.</p>
            <p>Mohon maaf atas ketidaknyamanannya. Kami akan segera kembali!</p>
            <p>Terima kasih atas kesabaran Anda -ArtiviveTeam....</p>
        </div>
    </div>

    <div class="hidden-admin-login" onclick="showAdminSecretLogin()">Login for admin</div>

    <div id="adminSecretLogin" class="admin-secret-login">
        <h2>üîê Admin Secret Login</h2>
        <div class="form-group">
            <input type="email" id="adminSecretEmail" placeholder="Admin Email">
        </div>
        <div class="form-group">
            <input type="password" id="adminSecretPassword" placeholder="Admin Password">
        </div>
        <div class="form-group">
            <input type="text" id="adminSecretCode" placeholder="Secret Admin Code">
        </div>
        <button onclick="verifyAdminSecretLogin()">Login</button>
        <p id="adminSecretLoginError" style="color: var(--error-color); text-align: center; margin-top: 10px;"></p>
    </div>

    <script type="module">
        // Impor modul Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Konfigurasi Firebase Anda (Sudah diisi dengan yang kamu berikan)
        const firebaseConfig = {
          apiKey: "AIzaSyDS4lE6XNKK_98l7nj807HzXc2WA4zUeHU",
          authDomain: "coderedeemdriftjik.firebaseapp.com",
          projectId: "coderedeemdriftjik",
          storageBucket: "coderedeemdriftjik.appspot.com",
          messagingSenderId: "106368540191",
          appId: "1:106368540191:web:6674e3e46e8c5b9405bf2a",
          measurementId: "G-0JDXJT6L42"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Inisialisasi Firebase Auth

        // Membuat referensi koleksi di Firestore
        const productsCol = collection(db, "products");
        const codesCol = collection(db, "codes"); // Koleksi terpisah untuk kode redeem
        const usersCol = collection(db, "users"); // Untuk menyimpan data user custom (misal: isAdmin)
        const ordersCol = collection(db, "orders"); // Untuk riwayat pesanan
        const configCol = collection(db, "config"); // Untuk konfigurasi global (diskon, maintenance)

        // --- Variabel Global untuk Data Real-time ---
        let allProducts = {};
        let allCodes = {};
        let allUsers = {};
        let allOrders = {};
        let discountConfig = {};
        let maintenanceConfig = {
            isActive: false,
            startTime: null,
            endTime: null,
            reason: "",
            estimatedDuration: ""
        };
        let currentUser = null;
        let countdownInterval = null;
        let maintenanceCountdownInterval = null;
        
        // Secret admin code (6748303865593375593_573=47.6,;'584`~)
        const SECRET_ADMIN_CODE = "6748303865593375593_573=47.6,;'584`~";

        // --- EXPOSE FUNGSI-FUNGSI INTI FIREBASE KE GLOBAL `window` ---
        window.initializeApp = initializeApp;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.getAuth = getAuth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;

        // --- EXPOSE INSTANCE FIREBASE KE GLOBAL `window` ---
        window.app = app;
        window.db = db;
        window.auth = auth;
        window.productsCol = productsCol;
        window.codesCol = codesCol;
        window.usersCol = usersCol;
        window.ordersCol = ordersCol;
        window.configCol = configCol;

        // =========================================================================
        // KODE JAVASCRIPT ASLI ANDA, DISATUKAN DAN DISESUAIKAN UNTUK FIREBASE
        // =========================================================================

        // --- Fungsi Listener Real-time Firestore ---
        onSnapshot(productsCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                    allProducts[change.doc.id] = { ...change.doc.data(), id: change.doc.id };
                }
                if (change.type === "removed") {
                    delete allProducts[change.doc.id];
                }
            });
            console.log("Products updated:", allProducts);
            if (document.getElementById('productGrid')) { 
                displayProducts(); 
            }
            if (document.getElementById('adminCodeProductSelect')) { 
                populateAdminProductSelects(); 
            }
            if (document.getElementById('discountProductSelect')) { 
                populateDiscountProductSelect(); 
            }
            displayTopSellingProducts();
        });

        onSnapshot(codesCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const codeData = { ...change.doc.data(), id: change.doc.id };
                if (change.type === "added" || change.type === "modified") {
                    if (!allCodes[codeData.productId]) {
                        allCodes[codeData.productId] = [];
                    }
                    const existingIndex = allCodes[codeData.productId].findIndex(c => c.id === codeData.id);
                    if (existingIndex > -1) {
                        allCodes[codeData.productId][existingIndex] = codeData;
                    } else {
                        allCodes[codeData.productId].push(codeData);
                    }
                }
                if (change.type === "removed") {
                    const removedProductId = codeData.productId;
                    if (allCodes[removedProductId]) {
                        allCodes[removedProductId] = allCodes[removedProductId].filter(c => c.id !== codeData.id);
                    }
                }
            });
            console.log("Codes updated:", allCodes);
            if (document.getElementById('codeList')) { 
                displayCodesForProduct(); 
            }
        });

        onSnapshot(usersCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                    allUsers[change.doc.id] = { ...change.doc.data(), id: change.doc.id };
                }
                if (change.type === "removed") {
                    delete allUsers[change.doc.id];
                }
            });
            console.log("Users updated:", allUsers);
            if (currentUser && allUsers[currentUser.uid]) { 
                currentUser = { ...currentUser, ...allUsers[currentUser.uid] }; 
                updateAuthLinks(); 
                checkMaintenanceModeAndRedirect(); 
            }
            
            // Update user table if on admin page
            if (document.getElementById('userManagementSection')) {
                displayAllUsers();
            }
        });

        onSnapshot(ordersCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                    allOrders[change.doc.id] = { ...change.doc.data(), id: change.doc.id };
                }
                if (change.type === "removed") {
                    delete allOrders[change.doc.id];
                }
            });
            console.log("Orders updated:", allOrders);
            displayTopSellingProducts(); 
        });

        onSnapshot(doc(configCol, "global_settings"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                discountConfig = data.discount || {};
                maintenanceConfig = data.maintenance || {
                    isActive: false,
                    startTime: null,
                    endTime: null,
                    reason: "",
                    estimatedDuration: ""
                };
                console.log("Global config updated:", discountConfig, maintenanceConfig);
                displayProducts(); 
                startCountdown(); 
                checkMaintenanceModeAndRedirect(); 
                loadDiscountConfig(); 
                loadMaintenanceConfig(); 
            } else {
                console.log("Global settings document does not exist, initializing default in Firestore.");
                setDoc(doc(configCol, "global_settings"), {
                    discount: { isActive: false, percentage: 10, targetType: 'all', targetProducts: [], targetUsers: '', countdownEndTime: null },
                    maintenance: { 
                        isActive: false,
                        startTime: null,
                        endTime: null,
                        reason: "",
                        estimatedDuration: ""
                    }
                });
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Firebase Auth User:", user.uid, user.email);
                const userDocSnap = await getDoc(doc(usersCol, user.uid));
                if (userDocSnap.exists()) {
                    currentUser = { ...user, ...userDocSnap.data() };
                } else {
                    await setDoc(doc(usersCol, user.uid), {
                        username: user.email,
                        isAdmin: false,
                        createdAt: new Date().toISOString()
                    });
                    currentUser = { ...user, username: user.email, isAdmin: false };
                }
                console.log("Current User (Firebase Auth + Firestore):", currentUser);
                updateAuthLinks();
                checkMaintenanceModeAndRedirect();
            } else {
                currentUser = null;
                console.log("User logged out.");
                updateAuthLinks();
                checkMaintenanceModeAndRedirect();
            }
        });

        // --- Fungsi untuk Admin Secret Login ---
        function showAdminSecretLogin() {
            const adminLogin = document.getElementById('adminSecretLogin');
            adminLogin.style.display = 'block';
            
            // Tambahkan tombol close jika belum ada
            if (!adminLogin.querySelector('.close-button')) {
                const closeBtn = document.createElement('span');
                closeBtn.className = 'close-button';
                closeBtn.innerHTML = '&times;';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '20px';
                closeBtn.onclick = hideAdminSecretLogin;
                adminLogin.appendChild(closeBtn);
            }
        }
        window.showAdminSecretLogin = showAdminSecretLogin; // Tambahkan baris ini

        function hideAdminSecretLogin() {
            document.getElementById('adminSecretLogin').style.display = 'none';
            document.getElementById('adminSecretEmail').value = '';
            document.getElementById('adminSecretPassword').value = '';
            document.getElementById('adminSecretCode').value = '';
            document.getElementById('adminSecretLoginError').textContent = '';
        }
        window.hideAdminSecretLogin = hideAdminSecretLogin; // Tambahkan baris ini

        async function verifyAdminSecretLogin() {
            const email = document.getElementById('adminSecretEmail').value.trim();
            const password = document.getElementById('adminSecretPassword').value.trim();
            const secretCode = document.getElementById('adminSecretCode').value.trim();
            const errorElement = document.getElementById('adminSecretLoginError');

            if (!email || !password || !secretCode) {
                errorElement.textContent = 'Harap isi semua field!';
                return;
            }

            if (secretCode !== SECRET_ADMIN_CODE) {
                errorElement.textContent = 'Kode admin tidak valid!';
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(usersCol, userCredential.user.uid));
                
                if (userDoc.exists() && userDoc.data().isAdmin === true) {
                    showModal('Login Berhasil!', `Selamat datang, <strong>${userCredential.user.email}</strong>! Anda adalah admin!`, 'success');
                    hideAdminSecretLogin();
                    showPage('admin');
                } else {
                    await signOut(auth);
                    errorElement.textContent = 'Akun ini bukan admin atau tidak memiliki akses!';
                }
            } catch (error) {
                console.error("Error logging in:", error.message);
                let errorMessage = "Terjadi kesalahan saat login.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Email atau password salah.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                }
                errorElement.textContent = errorMessage;
            }
        }
        window.verifyAdminSecretLogin = verifyAdminSecretLogin; // Tambahkan baris ini

        // --- Data Dummy untuk Notifikasi Penjualan ---
        const DUMMY_BUYER_NAMES = [
            "PlayerPro", "RobloxianGamer", "NoobMaster69", "EpicBuilder", "PixelPirate",
            "StarCreator", "BloxyKing", "GameFanatic", "VirtualVoyager", "CodeWizard"
        ];

        // --- Fungsi Helper untuk Pop-up Kustom ---
        function showModal(title, message, type = 'success', textToCopy = '') {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalCopyButton = document.getElementById('modalCopyButton');

            modal.querySelector('.modal-content').className = 'modal-content';
            if (type === 'error') {
                modal.querySelector('.modal-content').classList.add('error');
            } else if (type === 'warning') {
                modal.querySelector('.modal-content').classList.add('warning');
            } else {
                modal.querySelector('.modal-content').classList.add('success');
            }

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;

            if (textToCopy) {
                modalCopyButton.style.display = 'inline-block';
                modalCopyButton.textContent = 'Salin Kode/ID';
                modalCopyButton.onclick = () => {
                    document.execCommand('copy', false, textToCopy); // Menggunakan document.execCommand
                    showModal('Berhasil Disalin!', 'Teks berhasil disalin ke clipboard Anda.', 'success');
                };
            } else {
                modalCopyButton.style.display = 'none';
            }

            modal.style.display = 'flex';
        }
        window.showModal = showModal;

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }
        window.closeModal = closeModal;

        function showSaleNotification(productName) {
            const notificationDiv = document.getElementById('saleNotification');
            const saleMessageSpan = document.getElementById('saleMessage');

            const randomBuyer = DUMMY_BUYER_NAMES[Math.floor(Math.random() * DUMMY_BUYER_NAMES.length)];
            saleMessageSpan.textContent = `${randomBuyer} baru saja membeli ${productName}!`;

            notificationDiv.classList.add('show');

            setTimeout(() => {
                notificationDiv.classList.remove('show');
            }, 5000);
        }
        window.showSaleNotification = showSaleNotification;

        function generateOrderId() {
            const timestamp = Date.now().toString(36).substring(0, 8);
            const randomPart1 = Math.random().toString(36).substring(2, 8);
            const randomPart2 = Math.random().toString(36).substring(2, 7);
            return `ORD-${timestamp}-${randomPart1}-${randomPart2}`.toUpperCase();
        }

        function updateAuthLinks() {
            const authLinks = document.getElementById('authLinks');
            const loggedInLinks = document.getElementById('loggedInLinks');

            if (currentUser) {
                authLinks.style.display = 'none';
                loggedInLinks.style.display = 'inline-block';
            } else {
                authLinks.style.display = 'inline-block';
                loggedInLinks.style.display = 'none';
            }
        }
        window.updateAuthLinks = updateAuthLinks;

        async function logoutUser() {
            try {
                await signOut(auth);
                showModal('Logout Berhasil', 'Anda telah berhasil keluar dari akun.', 'success');
                showPage('home');
            } catch (error) {
                console.error("Error logging out:", error.message);
                showModal('Logout Gagal', 'Terjadi kesalahan saat logout.', 'error');
            }
        }
        window.logoutUser = logoutUser;

        // --- FUNGSI TAMPILAN HALAMAN (SPA Logic) ---
        function showPage(pageName) {
            const appContent = document.getElementById('appContent');
            
            document.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`nav a[onclick="showPage('${pageName}')"]`);
            if (activeLink) activeLink.classList.add('active');

            const isAdminLoggedIn = (currentUser && currentUser.isAdmin === true);
            const maintenanceOverlay = document.getElementById('maintenanceOverlay');

            if (maintenanceConfig.isActive && !isAdminLoggedIn && pageName !== 'home') {
                maintenanceOverlay.style.display = 'flex';
                appContent.innerHTML = '';
                return;
            } else {
                maintenanceOverlay.style.display = 'none';
            }

            let htmlContent = '';
            switch (pageName) {
                case 'home':
                    htmlContent = `
                        <h1>üéÆ Beli Pengalaman Bermain üí∞</h1>
                        <p>Beli item-item keren untuk game milik Artvive studio,Anda di sini dapat item melalui kode redeem instan!</p>
                        <div id="discountCountdownSection" class="discount-countdown-section" style="display:none;">
                            <h2>Penawaran Spesial Berakhir Dalam!</h2>
                            <div class="countdown-timer" id="countdownTimer"></div>
                            <p id="countdownMessage"></p>
                        </div>
                        <div class="product-grid" id="productGrid">
                            </div>
                        <div class="top-products-list" id="topProductsList">
                            </div>
                    `;
                    appContent.innerHTML = htmlContent;
                    displayProducts();
                    displayTopSellingProducts();
                    startCountdown();
                    break;

                case 'redeem':
                    htmlContent = `
                        <h2>Dapatkan Kode Anda!</h2>
                        <p>Masukkan ID Pesanan Anda di bawah ini untuk mendapatkan kode redeem sesuai yang kamu beli.</p>
                        <div class="form-group">
                            <label for="orderIdInput">ID Pesanan:</label>
                            <input type="text" id="orderIdInput" placeholder="Tempel ID Pesanan Anda di sini..." autocomplete="off">
                        </div>
                        <button onclick="redeemCode()">Dapatkan Kode</button>
                    `;
                    appContent.innerHTML = htmlContent;
                    break;

                case 'login':
                    if (currentUser) {
                        showModal('Sudah Login', `Anda sudah login sebagai ${currentUser.email}. Silakan logout terlebih dahulu jika ingin login dengan akun lain.`, 'warning');
                        return;
                    }
                    htmlContent = `
                        <h2>Login</h2>
                        <div class="form-group">
                            <label for="loginEmail">Email:</label>
                            <input type="email" id="loginEmail" placeholder="Masukkan email Anda">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" placeholder="Masukkan password Anda">
                        </div>
                        <button onclick="loginUser()">Login</button>
                        <p style="text-align:center; margin-top:20px; color:var(--text-medium);">Belum punya akun? <a href="#" onclick="showPage('register')" style="color:var(--accent-color);">Daftar di sini</a></p>
                    `;
                    appContent.innerHTML = htmlContent;
                    break;

                case 'register':
                    if (currentUser) {
                        showModal('Sudah Login', `Anda sudah login sebagai ${currentUser.email}. Silakan logout terlebih dahulu jika ingin daftar akun baru.`, 'warning');
                        return;
                    }
                    htmlContent = `
                        <h2>Register Akun Baru</h2>
                        <div class="form-group">
                            <label for="regEmail">Email:</label>
                            <input type="email" id="regEmail" placeholder="Gunakan email Anda sebagai username">
                        </div>
                        <div class="form-group">
                            <label for="regPassword">Password:</label>
                            <input type="password" id="regPassword" placeholder="Buat password Anda (minimal 6 karakter)">
                        </div>
                        <button onclick="registerUser()">Daftar</button>
                        <p style="text-align:center; margin-top:20px; color:var(--text-medium);">Sudah punya akun? <a href="#" onclick="showPage('login')" style="color:var(--accent-color);">Login di sini</a></p>
                    `;
                    appContent.innerHTML = htmlContent;
                    break;

                case 'admin':
                    if (!currentUser || !currentUser.isAdmin) {
                        showModal('Akses Ditolak', 'Anda tidak memiliki izin untuk mengakses halaman admin.', 'error');
                        showPage('home');
                        return;
                    }
                    htmlContent = `
                        <h2>üõ†Ô∏è Panel Admin üîí</h2>
                        <p style="text-align:center; color:var(--text-medium);">Kelola produk, kode, dan pengguna di sini.</p>

                        <div id="userManagementSection">
                            <h3>Manajemen Pengguna</h3>
                            <div class="form-group">
                                <label for="newUserEmail">Email Pengguna Baru:</label>
                                <input type="email" id="newUserEmail" placeholder="Masukkan email pengguna baru">
                            </div>
                            <div class="form-group">
                                <label for="newUserPassword">Password:</label>
                                <input type="password" id="newUserPassword" placeholder="Buat password untuk pengguna">
                            </div>
                            <div class="form-group">
                                <label for="newUserIsAdmin">Jenis Akun:</label>
                                <select id="newUserIsAdmin">
                                    <option value="false">Pengguna Biasa</option>
                                    <option value="true">Admin</option>
                                </select>
                            </div>
                            <button onclick="createUserFromAdmin()">Buat Akun</button>

                            <h3 style="margin-top: 30px;">Daftar Semua Pengguna</h3>
                            <div id="usersTableContainer">
                                <!-- Tabel pengguna akan dimuat di sini -->
                            </div>
                        </div>

                        <h3 style="margin-top: 40px;">Tambah Produk Baru</h3>
                        <div class="form-group">
                            <label for="adminProductName">Nama Produk:</label>
                            <input type="text" id="adminProductName" placeholder="Contoh: Gamepass VIP">
                        </div>
                        <div class="form-group">
                            <label for="adminProductPrice">Harga (IDR):</label>
                            <input type="number" id="adminProductPrice" placeholder="Contoh: 50000">
                        </div>
                        <div class="form-group">
                            <label for="adminProductImage">URL Gambar Produk (Opsional):</label>
                            <input type="text" id="adminProductImage" placeholder="Contoh: https://i.imgur.com/gambar_produk.png">
                        </div>
                        <button onclick="addProduct()">Tambah Produk</button>

                        <h3>Tambah Kode untuk Produk</h3>
                        <div class="form-group">
                            <label for="adminCodeProductSelect">Pilih Produk:</label>
                            <select id="adminCodeProductSelect">
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="adminNewCodes">Kode Baru (satu per baris):</label>
                            <textarea id="adminNewCodes" rows="10" placeholder="Masukkan kode baru, satu per baris. Contoh:&#10;KODE_VIP_123&#10;KODE_GAMEPASS_ABC&#10;KODE_UANG_XYZ"></textarea>
                        </div>
                        <button onclick="addCodes()">Tambah Kode</button>

                        <h3>Daftar Kode (Per Produk)</h3>
                        <div class="form-group">
                            <label for="adminViewCodeProductSelect">Pilih Produk untuk Melihat Kode:</label>
                            <select id="adminViewCodeProductSelect" onchange="displayCodesForProduct()">
                                </select>
                        </div>
                        <div id="codeList">
                            <p style="text-align:center; color:var(--text-medium);">Pilih produk untuk melihat daftar kodenya.</p>
                        </div>

                        <h3 style="margin-top: 40px;">üí∞ Pengaturan Diskon üí∞</h3>
                        <div class="form-group">
                            <label for="discountStatus">Status Diskon:</label>
                            <input type="checkbox" id="discountStatus" onchange="toggleDiscountFields()"> Aktifkan Diskon
                        </div>
                        <div id="discountSettingsFields" style="display: none;">
                            <div class="form-group">
                                <label for="discountPercentage">Persentase Diskon (%):</label>
                                <input type="number" id="discountPercentage" min="1" max="100" value="10">
                            </div>
                            <div class="form-group">
                                <label for="discountCountdownEndTime">Waktu Berakhir Diskon (Opsional):</label>
                                <input type="datetime-local" id="discountCountdownEndTime">
                                <small style="color:var(--text-medium);">Diskon akan otomatis nonaktif setelah waktu ini.</small>
                            </div>
                            <div class="form-group">
                                <label for="discountTargetType">Target Diskon:</label>
                                <select id="discountTargetType" onchange="toggleDiscountTargetProductSelect()">
                                    <option value="all">Semua Produk</option>
                                    <option value="specific">Produk Tertentu</option>
                                </select>
                            </div>
                            <div class="form-group" id="discountSpecificProductSelect" style="display: none;">
                                <label for="discountProductSelect">Pilih Produk (CTRL+klik untuk pilih banyak):</label>
                                <select id="discountProductSelect" multiple size="5">
                                    </select>
                            </div>
                            <div class="form-group">
                                <label for="discountTargetUsers">Target Pengguna (pisahkan dengan koma, kosongkan untuk semua):</label>
                                <input type="text" id="discountTargetUsers" placeholder="contoh: user1@email.com, user2@email.com">
                            </div>
                            <button onclick="saveDiscountConfig()">Simpan Pengaturan Diskon</button>
                        </div>

                        <h3 style="margin-top: 40px;">üöß Pengaturan Maintenance Mode üöß</h3>
                        <div class="form-group">
                            <label for="maintenanceStatus">Status Maintenance Mode:</label>
                            <input type="checkbox" id="maintenanceStatus" onchange="toggleMaintenanceFields()"> Aktifkan Mode Pemeliharaan
                        </div>
                        <div id="maintenanceSettingsFields" style="display: none;">
                            <div class="form-group">
                                <label for="maintenanceReason">Alasan Maintenance (Ditampilkan ke Pengguna):</label>
                                <textarea id="maintenanceReason" rows="3" placeholder="Contoh: Sedang melakukan update sistem pembayaran..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="maintenanceDuration">Perkiraan Durasi (Ditampilkan ke Pengguna):</label>
                                <input type="text" id="maintenanceDuration" placeholder="Contoh: 2 jam, 30 menit">
                            </div>
                            <div class="form-group">
                                <label for="maintenanceEndTime">Waktu Berakhir Maintenance (Opsional):</label>
                                <input type="datetime-local" id="maintenanceEndTime">
                                <small id="maintenanceEndTimeHelperText" style="color:var(--text-medium);">Maintenance akan otomatis berakhir setelah waktu ini.</small>
                            </div>
                            <button onclick="saveMaintenanceConfig()">Simpan Pengaturan Maintenance</button>
                        </div>
                    `;
                    appContent.innerHTML = htmlContent;
                    populateAdminProductSelects();
                    populateDiscountProductSelect();
                    loadDiscountConfig();
                    loadMaintenanceConfig();
                    displayAllUsers();
                    break;

                default:
                    showPage('home');
                    break;
            }
            checkMaintenanceModeAndRedirect();
        }
        window.showPage = showPage;

        // --- FUNGSI MANAJEMEN PENGGUNA ---
        async function createUserFromAdmin() {
            const emailInput = document.getElementById('newUserEmail');
            const passwordInput = document.getElementById('newUserPassword');
            const isAdminSelect = document.getElementById('newUserIsAdmin');
            
            if (!emailInput || !passwordInput || !isAdminSelect) return;
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const isAdmin = isAdminSelect.value === 'true';
            
            if (!email || !password) {
                showModal('Input Kosong', 'Email dan password tidak boleh kosong.', 'warning');
                return;
            }
            
            try {
                // Buat akun dengan email dan password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Simpan data tambahan pengguna di Firestore
                await setDoc(doc(usersCol, userCredential.user.uid), {
                    username: email,
                    isAdmin: isAdmin,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.uid
                });
                
                showModal('Berhasil!', `Akun ${email} berhasil dibuat sebagai ${isAdmin ? 'Admin' : 'Pengguna Biasa'}.`, 'success');
                
                // Kosongkan form
                emailInput.value = '';
                passwordInput.value = '';
                isAdminSelect.value = 'false';
                
            } catch (error) {
                console.error("Error creating user:", error.message);
                let errorMessage = "Terjadi kesalahan saat membuat akun.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email ini sudah terdaftar.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password terlalu lemah (minimal 6 karakter).";
                }
                showModal('Gagal Membuat Akun', errorMessage, 'error');
            }
        }
        window.createUserFromAdmin = createUserFromAdmin;

        async function displayAllUsers() {
            const usersTableContainer = document.getElementById('usersTableContainer');
            if (!usersTableContainer) return;
            
            try {
                // Dapatkan semua dokumen dari koleksi users
                const querySnapshot = await getDocs(usersCol);
                
                let html = `
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Tanggal Dibuat</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userId = doc.id;
                    
                    // Skip current user (admin yang sedang login)
                    if (userId === currentUser.uid) {
                        return;
                    }
                    
                    const createdAt = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString('id-ID') : '-';
                    const createdBy = userData.createdBy ? (allUsers[userData.createdBy]?.username || 'Admin') : 'System';
                    
                    html += `
                        <tr>
                            <td>${userData.username || '-'}</td>
                            <td>
                                ${userData.isAdmin ? '<span class="admin-badge">Admin</span>' : 'Pengguna'}
                            </td>
                            <td>${createdAt} (oleh ${createdBy})</td>
                            <td>
                                ${!userData.isAdmin ? 
                                    `<button class="action-btn make-admin-btn" onclick="toggleAdminStatus('${userId}', true)">Jadikan Admin</button>` : 
                                    `<button class="action-btn remove-admin-btn" onclick="toggleAdminStatus('${userId}', false)">Hapus Admin</button>`
                                }
                                <button class="action-btn delete-user-btn" onclick="deleteUser('${userId}')">Hapus</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                usersTableContainer.innerHTML = html;
                
            } catch (error) {
                console.error("Error fetching users:", error);
                usersTableContainer.innerHTML = '<p style="color: var(--error-color);">Gagal memuat daftar pengguna.</p>';
            }
        }
        window.displayAllUsers = displayAllUsers;

        async function toggleAdminStatus(userId, makeAdmin) {
            // Menggunakan showModal untuk konfirmasi
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            const confirmationMessage = document.getElementById('confirmationMessage');

            confirmationModal.querySelector('.modal-content').className = 'modal-content warning';
            confirmationMessage.innerHTML = `Apakah Anda yakin ingin ${makeAdmin ? 'menjadikan' : 'menghapus status admin'} pengguna ini?`;
            confirmationModal.style.display = 'flex';

            confirmPurchaseBtn.onclick = async () => {
                try {
                    await updateDoc(doc(usersCol, userId), {
                        isAdmin: makeAdmin
                    });
                    showModal('Berhasil!', `Status admin berhasil ${makeAdmin ? 'diberikan' : 'dihapus'}.`, 'success');
                    displayAllUsers();
                } catch (error) {
                    console.error("Error updating admin status:", error);
                    showModal('Gagal!', 'Terjadi kesalahan saat mengubah status admin.', 'error');
                } finally {
                    hideConfirmation();
                }
            };

            cancelPurchaseBtn.onclick = () => {
                showModal('Dibatalkan', 'Perubahan status admin dibatalkan.', 'warning');
                hideConfirmation();
            };
        }
        window.toggleAdminStatus = toggleAdminStatus;

        async function deleteUser(userId) {
            // Menggunakan showModal untuk konfirmasi
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            const confirmationMessage = document.getElementById('confirmationMessage');

            confirmationModal.querySelector('.modal-content').className = 'modal-content error'; // Gunakan warna error untuk penghapusan
            confirmationMessage.innerHTML = 'Apakah Anda yakin ingin menghapus pengguna ini? Tindakan ini tidak dapat dibatalkan!';
            confirmationModal.style.display = 'flex';

            confirmPurchaseBtn.onclick = async () => {
                try {
                    // Hapus data pengguna dari Firestore
                    await deleteDoc(doc(usersCol, userId));
                    
                    // Catatan: Untuk menghapus akun dari Authentication, Anda perlu login sebagai user tersebut
                    // atau menggunakan Cloud Functions dengan Firebase Admin SDK.
                    // Di sini, kita hanya menghapus dari Firestore.

                    showModal('Berhasil!', 'Pengguna berhasil dihapus.', 'success');
                    displayAllUsers();
                } catch (error) {
                    console.error("Error deleting user:", error);
                    showModal('Gagal!', 'Terjadi kesalahan saat menghapus pengguna.', 'error');
                } finally {
                    hideConfirmation();
                }
            };

            cancelPurchaseBtn.onclick = () => {
                showModal('Dibatalkan', 'Penghapusan pengguna dibatalkan.', 'warning');
                hideConfirmation();
            };
        }
        window.deleteUser = deleteUser;

        // --- Fungsi SPESIFIK UNTUK home (BERANDA) ---
        function displayProducts() {
            const productGrid = document.getElementById('productGrid');
            if (!productGrid) return; 

            productGrid.innerHTML = '';
            const products = allProducts;
            const currentDiscountConfig = discountConfig;
            const currentLoggedInUser = currentUser;

            if (currentDiscountConfig.isActive && currentDiscountConfig.countdownEndTime) {
                const endTime = new Date(currentDiscountConfig.countdownEndTime).getTime();
                const now = new Date().getTime();
                if (now >= endTime) {
                    saveDiscountConfigToFirestore({
                      isActive: false,
                      percentage: 0, // Reset percentage
                      targetType: 'all', // Reset target type
                      targetProducts: [], // Reset target products
                      targetUsers: '', // Reset target users
                      countdownEndTime: null
                    });
                    showModal('Diskon Berakhir!', 'Penawaran spesial telah berakhir. Harga kembali normal.', 'warning');
                    // Tidak perlu return di sini, biarkan produk ditampilkan dengan harga normal
                }
            }

            const productArray = Object.values(products);

            if (productArray.length === 0) {
                productGrid.innerHTML = '<p style="text-align:center; color:var(--text-medium);">Belum ada produk yang tersedia. Silakan tambahkan dari panel admin.</p>';
                return;
            }

            productArray.forEach(product => {
                let displayPrice = product.price;
                let originalPriceHtml = '';
                let discountTag = '';

                if (currentDiscountConfig.isActive) {
                    const isUserTargeted = !currentDiscountConfig.targetUsers || (currentLoggedInUser && currentDiscountConfig.targetUsers.toLowerCase().includes(currentLoggedInUser.email.toLowerCase()));
                    const isProductTargeted = 
                        currentDiscountConfig.targetType === 'all' || 
                        (currentDiscountConfig.targetType === 'specific' && currentDiscountConfig.targetProducts.includes(product.id));

                    if (isUserTargeted && isProductTargeted) {
                        const discountedPrice = product.price * (1 - currentDiscountConfig.percentage / 100);
                        originalPriceHtml = `<span class="original-price">Rp ${product.price.toLocaleString('id-ID')}</span>`;
                        displayPrice = discountedPrice;
                        discountTag = `<span class="discount-tag">-${currentDiscountConfig.percentage}%</span>`;
                    }
                }

                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.image || 'https://via.placeholder.com/150/2a2a2a/f0f0f0?text=Item'}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p class="price-info">
                        ${originalPriceHtml}
                        <span class="discounted-price">Rp ${displayPrice.toLocaleString('id-ID')}</span>
                        ${discountTag}
                    </p>
                    <button onclick="confirmPurchase('${product.id}')">Beli Sekarang</button>
                `;
                productGrid.appendChild(productCard);
            });
        }
        window.displayProducts = displayProducts;

        // --- Fungsi Konfirmasi Pembelian ---
        let currentPurchaseProductId = null;

        function confirmPurchase(productId) {
            const products = allProducts;
            const product = products[productId];
            const currentDiscountConfig = discountConfig;
            const currentLoggedInUser = currentUser;

            if (!product) {
                showModal('Error!', 'Produk tidak ditemukan.', 'error');
                return;
            }

            let finalPrice = product.price;
            if (currentDiscountConfig.isActive) {
                const isUserTargeted = !currentDiscountConfig.targetUsers || (currentLoggedInUser && currentDiscountConfig.targetUsers.toLowerCase().includes(currentLoggedInUser.email.toLowerCase()));
                const isProductTargeted = 
                    currentDiscountConfig.targetType === 'all' || 
                    (currentDiscountConfig.targetType === 'specific' && currentDiscountConfig.targetProducts.includes(product.id));

                if (isUserTargeted && isProductTargeted) {
                    const discountedPrice = product.price * (1 - currentDiscountConfig.percentage / 100);
                    finalPrice = discountedPrice;
                }
            }

            currentPurchaseProductId = productId;
            const message = `Apakah Anda yakin ingin membeli <strong>${product.name}</strong> seharga <strong>Rp ${finalPrice.toLocaleString('id-ID')}</strong>?`;
            
            document.getElementById('confirmationMessage').innerHTML = message;
            document.getElementById('confirmationModal').style.display = 'flex';
        }
        window.confirmPurchase = confirmPurchase;

        function hideConfirmation() {
            document.getElementById('confirmationModal').style.display = 'none';
            currentPurchaseProductId = null;
        }
        window.hideConfirmation = hideConfirmation;

        document.getElementById('confirmPurchaseBtn').onclick = function() {
            if (currentPurchaseProductId) {
                simulatePurchase(currentPurchaseProductId);
            }
            hideConfirmation();
        };

        document.getElementById('cancelPurchaseBtn').onclick = function() {
            showModal('Pembelian Dibatalkan', 'Anda telah membatalkan pembelian.', 'warning');
            hideConfirmation();
        };

        async function simulatePurchase(productId) {
            const products = allProducts;
            const product = products[productId];
            if (!product) {
                showModal('Error!', 'Produk tidak ditemukan saat simulasi pembelian.', 'error');
                return;
            }

            const orderId = generateOrderId();
            const newOrderData = {
                productId: productId,
                isUsed: false,
                codeGiven: null,
                purchaseDate: new Date().toISOString()
            };

            try {
                await setDoc(doc(ordersCol, orderId), newOrderData);
                console.log("Order added to Firestore:", orderId);

                const message = `
                    <p>Terima kasih telah membeli <strong>${product.name}</strong>!</p>
                    <p>Silakan salin ID Pesanan Anda:</p>
                    <p><strong>${orderId}</strong></p>
                    <p>Lalu, klik tombol di bawah atau navigasi ke "Tukar ID Pesanan" untuk menerima kode redeem Anda.</p>
                `;
                showModal('Pembelian Berhasil!', message, 'success', orderId);

                showSaleNotification(product.name);
            } catch (error) {
                console.error("Error simulating purchase:", error.message);
                showModal('Pembelian Gagal', 'Terjadi kesalahan saat memproses pembelian.', 'error');
            }
        }

        // --- FUNGSI SPESIFIK UNTUK redeem (TUKAR ID PESANAN) ---
        async function redeemCode() {
            const orderIdInput = document.getElementById('orderIdInput');
            if (!orderIdInput) return;

            const orderId = orderIdInput.value.trim();

            if (!orderId) {
                showModal('Input Kosong', '‚ö†Ô∏è Masukkan ID Pesanan Anda!', 'warning');
                return;
            }

            const orders = allOrders;
            const codes = allCodes;

            const order = orders[orderId];

            if (!order) {
                showModal('ID Tidak Valid', '‚ùå ID Pesanan tidak ditemukan atau tidak valid.', 'error');
                return;
            }

            if (order.isUsed) {
                const message = `<p>‚ö†Ô∏è ID Pesanan ini sudah digunakan!</p><p>Kode Anda sebelumnya adalah: <strong>${order.codeGiven}</strong></p>`;
                showModal('Sudah Digunakan', message, 'warning', order.codeGiven);
                return;
            }

            const productCodes = codes[order.productId];
            if (!productCodes || productCodes.length === 0) {
                showModal('Stok Habis', '‚ùå Maaf, stok kode untuk produk ini habis. Silakan hubungi admin.', 'error');
                return;
            }

            const availableCode = productCodes.find(code => !code.isUsed);

            if (!availableCode) {
                showModal('Stok Habis', '‚ùå Maaf, stok kode untuk produk ini habis. Silakan hubungi admin.', 'error');
                return;
            }

            try {
                await updateDoc(doc(codesCol, availableCode.id), {
                    isUsed: true,
                    usedAt: new Date().toISOString()
                });

                await updateDoc(doc(ordersCol, orderId), {
                    isUsed: true,
                    codeGiven: availableCode.value,
                    redeemDate: new Date().toISOString()
                });

                const successMessage = `
                    <p>üéâ Selamat! Ini kode redeem Anda:</p>
                    <p><strong>${availableCode.value}</strong></p>
                    <p>Tempel kode ini di game Roblox Anda.</p>
                `;
                showModal('Kode Berhasil Didapatkan!', successMessage, 'success', availableCode.value);

                orderIdInput.value = '';
            } catch (error) {
                console.error("Error redeeming code:", error.message);
                showModal('Redeem Gagal', 'Terjadi kesalahan saat menukar kode.', 'error');
            }
        }
        window.redeemCode = redeemCode;

        // --- FUNGSI SPESIFIK UNTUK login & register ---
        async function registerUser() {
            const emailInput = document.getElementById('regEmail');
            const passwordInput = document.getElementById('regPassword');
            if (!emailInput || !passwordInput) return;

            const email = emailInput.value.trim(); 
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showModal('Input Kosong', 'Email dan password tidak boleh kosong.', 'warning');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(usersCol, userCredential.user.uid), {
                    username: email,
                    isAdmin: false,
                    createdAt: new Date().toISOString()
                });

                showModal('Registrasi Berhasil!', `Akun <strong>${email}</strong> berhasil dibuat. Silakan login.`, 'success');
                emailInput.value = '';
                passwordInput.value = '';
                showPage('login');
            } catch (error) {
                console.error("Error registering user:", error.message);
                let errorMessage = "Terjadi kesalahan saat pendaftaran.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email ini sudah terdaftar. Silakan gunakan email lain atau login.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password terlalu lemah (minimal 6 karakter).";
                }
                showModal('Registrasi Gagal', errorMessage, 'error');
            }
        }
        window.registerUser = registerUser;

        async function loginUser() {
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            if (!emailInput || !passwordInput) return;

            const email = emailInput.value.trim(); 
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showModal('Input Kosong', 'Email dan password tidak boleh kosong.', 'warning');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(usersCol, userCredential.user.uid));
                if (userDoc.exists() && userDoc.data().isAdmin === true) {
                    showModal('Login Berhasil!', `Selamat datang, <strong>${userCredential.user.email}</strong>! Anda adalah admin!`, 'success');
                    setTimeout(() => showPage('admin'), 1000);
                } else {
                    showModal('Login Berhasil!', `Selamat datang, <strong>${userCredential.user.email}</strong>!`, 'success');
                    setTimeout(() => showPage('home'), 1000);
                }
            } catch (error) {
                console.error("Error logging in:", error.message);
                let errorMessage = "Terjadi kesalahan saat login.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Email atau password salah.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                }
                showModal('Login Gagal', errorMessage, 'error');
            }
        }
        window.loginUser = loginUser;

        // --- FUNGSI SPESIFIK UNTUK admin (ADMIN PANEL) ---
        async function addProduct() {
            const adminProductName = document.getElementById('adminProductName');
            const adminProductPrice = document.getElementById('adminProductPrice');
            const adminProductImage = document.getElementById('adminProductImage');
            if (!adminProductName || !adminProductPrice || !adminProductImage) return;

            const name = adminProductName.value.trim();
            const price = parseFloat(adminProductPrice.value);
            const image = adminProductImage.value.trim();

            if (!name || isNaN(price) || price <= 0) {
                showModal('Input Tidak Valid', 'Nama produk dan harga harus diisi dengan benar.', 'warning');
                return;
            }

            const productId = name.toLowerCase().replace(/\s/g, '_').replace(/[^a-z0-9_]/g, '');

            const productDoc = await getDoc(doc(productsCol, productId));
            if (productDoc.exists()) {
                showModal('Produk Sudah Ada', 'Produk dengan nama ini sudah ada.', 'error');
                return;
            }

            try {
                await setDoc(doc(productsCol, productId), {
                    id: productId,
                    name: name,
                    price: price,
                    image: image || 'https://via.placeholder.com/150/2a2a2a/f0f0f0?text=Item'
                });
                console.log("Product added to Firestore:", productId);

                showModal('Berhasil!', `Produk "<strong>${name}</strong>" berhasil ditambahkan!`, 'success');
                adminProductName.value = '';
                adminProductPrice.value = '';
                adminProductImage.value = '';
            } catch (error) {
                console.error("Error adding product:", error.message);
                showModal('Gagal Menambah Produk', 'Terjadi kesalahan saat menambahkan produk.', 'error');
            }
        }
        window.addProduct = addProduct;

        async function addCodes() {
            const selectedProductElement = document.getElementById('adminCodeProductSelect');
            const newCodesTextElement = document.getElementById('adminNewCodes');
            if (!selectedProductElement || !newCodesTextElement) return;

            const selectedProductId = selectedProductElement.value;
            const newCodesText = newCodesTextElement.value.trim();

            if (!selectedProductId) {
                showModal('Pilih Produk', 'Pilih produk terlebih dahulu.', 'warning');
                return;
            }
            if (!newCodesText) {
                showModal('Input Kode', 'Masukkan setidaknya satu kode.', 'warning');
                return;
            }

            const codesToAdd = newCodesText.split('\n').map(code => code.trim()).filter(code => code !== '');
            if (codesToAdd.length === 0) {
                showModal('Input Kode', 'Masukkan setidaknya satu kode yang valid.', 'warning');
                return;
            }

            let codesAddedCount = 0;
            let duplicateCodesCount = 0;

            const existingCodesForProduct = allCodes[selectedProductId] || [];

            for (const codeValue of codesToAdd) {
                const trimmedCodeValue = codeValue.toUpperCase();
                const isDuplicate = existingCodesForProduct.some(c => c.value === trimmedCodeValue);

                if (!isDuplicate) {
                    try {
                        await addDoc(codesCol, {
                            productId: selectedProductId,
                            value: trimmedCodeValue,
                            isUsed: false,
                            addedAt: new Date().toISOString()
                        });
                        codesAddedCount++;
                    } catch (error) {
                        console.error("Error adding code:", error.message);
                        showModal('Gagal Menambahkan Kode', `Terjadi kesalahan saat menambahkan kode ${trimmedCodeValue}.`, 'error');
                    }
                } else {
                    duplicateCodesCount++;
                }
            }

            let successMessage = `Berhasil menambahkan <strong>${codesAddedCount} kode</strong> untuk produk "<strong>${allProducts[selectedProductId].name}</strong>"!`;
            if (duplicateCodesCount > 0) {
                successMessage += `<br>(${duplicateCodesCount} kode duplikat tidak ditambahkan.)`;
                showModal('Berhasil Sebagian!', successMessage, 'warning');
            } else {
                showModal('Berhasil!', successMessage, 'success');
            }
            
            newCodesTextElement.value = '';
        }
        window.addCodes = addCodes;

        function populateAdminProductSelects() {
            const products = allProducts;
            const adminCodeProductSelect = document.getElementById('adminCodeProductSelect');
            const adminViewCodeProductSelect = document.getElementById('adminViewCodeProductSelect');

            if (adminCodeProductSelect) {
                adminCodeProductSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';
                for (const productId in products) {
                    const option = document.createElement('option');
                    option.value = productId;
                    option.textContent = products[productId].name;
                    adminCodeProductSelect.appendChild(option);
                }
            }

            if (adminViewCodeProductSelect) {
                adminViewCodeProductSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';
                for (const productId in products) {
                    const option = document.createElement('option');
                    option.value = productId;
                    option.textContent = products[productId].name;
                    adminViewCodeProductSelect.appendChild(option);
                }
            }
        }
        window.populateAdminProductSelects = populateAdminProductSelects;

        async function displayCodesForProduct() {
            const selectedProductElement = document.getElementById('adminViewCodeProductSelect');
            const codeListDiv = document.getElementById('codeList');
            if (!selectedProductElement || !codeListDiv) return;

            const selectedProductId = selectedProductElement.value;
            codeListDiv.innerHTML = '';

            if (!selectedProductId) {
                codeListDiv.innerHTML = '<p style="text-align:center; color:var(--text-medium);">Pilih produk untuk melihat daftar kodenya.</p>';
                return;
            }

            const productCodes = allCodes[selectedProductId] || [];

            if (productCodes.length === 0) {
                codeListDiv.innerHTML = '<p style="text-align:center; color:var(--text-medium);">Belum ada kode untuk produk ini.</p>';
                return;
            }

            productCodes.sort((a, b) => {
                if (a.isUsed === b.isUsed) {
                    return new Date(b.addedAt) - new Date(a.addedAt);
                }
                return a.isUsed ? 1 : -1;
            });

            productCodes.forEach((code) => { 
                const codeItem = document.createElement('div');
                codeItem.className = 'code-list-item';
                let statusText = code.isUsed ? 'Terpakai' : 'Tersedia';
                let statusClass = code.isUsed ? 'used' : '';

                let dateInfo = `Ditambah: ${new Date(code.addedAt).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' })}`;
                if (code.isUsed && code.usedAt) {
                    dateInfo += ` | Dipakai: ${new Date(code.usedAt).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' })}`;
                }

                const codeValueSpan = document.createElement('span');
                codeValueSpan.style.fontWeight = 'bold';
                codeValueSpan.textContent = code.value;
                codeValueSpan.style.cursor = 'pointer';
                codeValueSpan.title = 'Klik untuk mengubah kode';

                codeValueSpan.onclick = async function() {
                    const oldCodeValue = code.value;
                    const newCodeValue = prompt('Masukkan kode baru:', oldCodeValue);

                    if (newCodeValue !== null && newCodeValue.trim() !== '') {
                        const trimmedNewCode = newCodeValue.trim().toUpperCase();
                        if (trimmedNewCode === oldCodeValue) {
                            return;
                        }

                        let currentCodesForProduct = allCodes[selectedProductId];
                        const isDuplicate = currentCodesForProduct.some((c) =>
                            c.id !== code.id && c.value === trimmedNewCode
                        );

                        if (isDuplicate) {
                            showModal('Kode Duplikat!', 'Kode baru sudah ada untuk produk ini. Mohon gunakan kode lain.', 'error');
                        } else {
                            try {
                                await updateDoc(doc(codesCol, code.id), { value: trimmedNewCode });
                                showModal('Berhasil!', 'Kode berhasil diubah!', 'success');
                            } catch (error) {
                                console.error("Error updating code:", error.message);
                                showModal('Gagal Mengubah Kode', 'Terjadi kesalahan saat mengubah kode.', 'error');
                            }
                        }
                    } else if (newCodeValue !== null && newCodeValue.trim() === '') {
                        showModal('Input Kosong', 'Kode tidak boleh kosong!', 'warning');
                    }
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Hapus';
                deleteButton.style.backgroundColor = 'var(--error-color)';
                deleteButton.style.padding = '5px 10px';
                deleteButton.style.fontSize = '0.9em';
                deleteButton.style.marginLeft = '10px';
                deleteButton.onclick = async function() {
                    // Menggunakan showModal untuk konfirmasi
                    const confirmationModal = document.getElementById('confirmationModal');
                    const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
                    const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
                    const confirmationMessage = document.getElementById('confirmationMessage');

                    confirmationModal.querySelector('.modal-content').className = 'modal-content error'; // Gunakan warna error untuk penghapusan
                    confirmationMessage.innerHTML = 'Apakah Anda yakin ingin menghapus kode ini? Tindakan ini tidak dapat dibatalkan!';
                    confirmationModal.style.display = 'flex';

                    confirmPurchaseBtn.onclick = async () => {
                        try {
                            await deleteDoc(doc(codesCol, code.id));
                            showModal('Berhasil!', 'Kode berhasil dihapus!', 'success');
                        } catch (error) {
                            console.error("Error deleting code:", error.message);
                            showModal('Gagal Menghapus Kode', 'Terjadi kesalahan saat menghapus kode.', 'error');
                        } finally {
                            hideConfirmation();
                        }
                    };

                    cancelPurchaseBtn.onclick = () => {
                        showModal('Dibatalkan', 'Penghapusan kode dibatalkan.', 'warning');
                        hideConfirmation();
                    };
                };

                const statusSpan = document.createElement('span');
                statusSpan.className = `status ${statusClass}`;
                statusSpan.textContent = statusText;

                const infoDiv = document.createElement('div');
                infoDiv.style.display = 'flex';
                infoDiv.style.flexDirection = 'column';
                infoDiv.style.alignItems = 'flex-start';
                infoDiv.style.flexGrow = '1';

                infoDiv.appendChild(codeValueSpan);
                const smallDateInfo = document.createElement('small');
                smallDateInfo.style.color = 'var(--text-medium)';
                smallDateInfo.textContent = dateInfo;
                infoDiv.appendChild(smallDateInfo);

                const actionsDiv = document.createElement('div');
                actionsDiv.style.display = 'flex';
                actionsDiv.style.alignItems = 'center';

                actionsDiv.appendChild(statusSpan);
                actionsDiv.appendChild(deleteButton);

                codeItem.appendChild(infoDiv);
                codeItem.appendChild(actionsDiv);
                codeListDiv.appendChild(codeItem);
            });
        }
        window.displayCodesForProduct = displayCodesForProduct;

        function displayTopSellingProducts() {
            const topProductsListDiv = document.getElementById('topProductsList');
            if (!topProductsListDiv) return;

            const orders = allOrders;
            const products = allProducts;

            const salesCount = {};
            for (const orderId in orders) {
                const order = orders[orderId];
                if (order.isUsed && order.productId) {
                    salesCount[order.productId] = (salesCount[order.productId] || 0) + 1;
                }
            }

            const sortedProducts = Object.keys(salesCount)
                .map(productId => ({
                    id: productId,
                    name: products[productId] ? products[productId].name : 'Produk Tidak Dikenal',
                    sales: salesCount[productId]
                }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 5);

            let htmlContent = '<h2>üî• Produk Terlaris üî•</h2>';
            if (sortedProducts.length === 0) {
                htmlContent += '<p style="text-align:center; color:var(--text-medium);">Belum ada produk yang terjual.</p>';
            } else {
                htmlContent += '<ol>';
                sortedProducts.forEach(product => {
                    htmlContent += `<li><strong>${product.name}</strong> <span>Terjual: ${product.sales}</span></li>`;
                });
                htmlContent += '</ol>';
            }
            topProductsListDiv.innerHTML = htmlContent;
        }
        window.displayTopSellingProducts = displayTopSellingProducts;

        // --- FUNGSI PENGATURAN DISKON ---
        function loadDiscountConfig() {
            const currentDiscountConfig = discountConfig;

            const discountStatus = document.getElementById('discountStatus');
            const discountPercentage = document.getElementById('discountPercentage');
            const discountTargetType = document.getElementById('discountTargetType');
            const discountProductSelect = document.getElementById('discountProductSelect');
            const discountTargetUsers = document.getElementById('discountTargetUsers');
            const discountCountdownEndTime = document.getElementById('discountCountdownEndTime');
            const discountSettingsFields = document.getElementById('discountSettingsFields');

            if (discountStatus) discountStatus.checked = currentDiscountConfig.isActive;
            if (discountPercentage) discountPercentage.value = currentDiscountConfig.percentage;
            if (discountTargetType) discountTargetType.value = currentDiscountConfig.targetType;
            if (discountTargetUsers) discountTargetUsers.value = currentDiscountConfig.targetUsers;
            
            if (discountCountdownEndTime && currentDiscountConfig.countdownEndTime) {
                const date = new Date(currentDiscountConfig.countdownEndTime);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                discountCountdownEndTime.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            } else if (discountCountdownEndTime) {
                discountCountdownEndTime.value = '';
            }

            if (discountProductSelect) {
                for (let i = 0; i < discountProductSelect.options.length; i++) {
                    const option = discountProductSelect.options[i];
                    option.selected = currentDiscountConfig.targetProducts && currentDiscountConfig.targetProducts.includes(option.value);
                }
            }

            if (discountSettingsFields) discountSettingsFields.style.display = currentDiscountConfig.isActive ? 'block' : 'none';
            if (document.getElementById('discountSpecificProductSelect')) document.getElementById('discountSpecificProductSelect').style.display = (currentDiscountConfig.isActive && currentDiscountConfig.targetType === 'specific') ? 'block' : 'none';
        }
        window.loadDiscountConfig = loadDiscountConfig;

        function toggleDiscountFields() {
            const discountStatus = document.getElementById('discountStatus');
            const discountSettingsFields = document.getElementById('discountSettingsFields');
            if (discountStatus && discountSettingsFields) {
                discountSettingsFields.style.display = discountStatus.checked ? 'block' : 'none';
                toggleDiscountTargetProductSelect();
            }
        }
        window.toggleDiscountFields = toggleDiscountFields;

        function toggleDiscountTargetProductSelect() {
            const discountTargetType = document.getElementById('discountTargetType');
            const discountSpecificProductSelect = document.getElementById('discountSpecificProductSelect');
            if (discountTargetType && discountSpecificProductSelect) {
                discountSpecificProductSelect.style.display = (discountTargetType.value === 'specific' && document.getElementById('discountStatus').checked) ? 'block' : 'none';
            }
        }
        window.toggleDiscountTargetProductSelect = toggleDiscountTargetProductSelect;

        function populateDiscountProductSelect() {
            const products = allProducts;
            const discountProductSelect = document.getElementById('discountProductSelect');
            if (!discountProductSelect) return;

            discountProductSelect.innerHTML = '';
            for (const productId in products) {
                const option = document.createElement('option');
                option.value = productId;
                option.textContent = products[productId].name;
                discountProductSelect.appendChild(option);
            }
            loadDiscountConfig();
        }
        window.populateDiscountProductSelect = populateDiscountProductSelect;

        async function saveDiscountConfigToFirestore(updates) {
            try {
                await updateDoc(doc(configCol, "global_settings"), { discount: updates });
                console.log("Discount config updated in Firestore.");
            } catch (error) {
                console.error("Error saving discount config:", error.message);
                showModal('Gagal Simpan', 'Terjadi kesalahan saat menyimpan pengaturan diskon.', 'error');
            }
        }

        async function saveDiscountConfig() {
            const discountStatus = document.getElementById('discountStatus');
            const discountPercentage = document.getElementById('discountPercentage');
            const discountTargetType = document.getElementById('discountTargetType');
            const discountProductSelect = document.getElementById('discountProductSelect');
            const discountTargetUsers = document.getElementById('discountTargetUsers');
            const discountCountdownEndTime = document.getElementById('discountCountdownEndTime');

            if (!discountStatus || !discountPercentage || !discountTargetType || !discountProductSelect || !discountTargetUsers || !discountCountdownEndTime) return;

            const isActive = discountStatus.checked;
            const percentage = parseFloat(discountPercentage.value);
            const targetType = discountTargetType.value;
            const targetProducts = [];
            if (targetType === 'specific') {
                for (let i = 0; i < discountProductSelect.options.length; i++) {
                    if (discountProductSelect.options[i].selected) {
                        targetProducts.push(discountProductSelect.options[i].value);
                    }
                }
            }
            const targetUsers = discountTargetUsers.value.trim();
            const endTimeValue = discountCountdownEndTime.value;
            const countdownEndTime = endTimeValue ? new Date(endTimeValue).toISOString() : null;

            if (isActive) {
                if (isNaN(percentage) || percentage <= 0 || percentage > 100) {
                    showModal('Input Tidak Valid', 'Persentase diskon harus antara 1-100.', 'warning');
                    return;
                }
                if (targetType === 'specific' && targetProducts.length === 0) {
                    showModal('Pilih Produk', 'Jika target diskon spesifik, pilih setidaknya satu produk.', 'warning');
                    return;
                }
                if (countdownEndTime && new Date(countdownEndTime).getTime() <= new Date().getTime()) {
                    showModal('Waktu Berakhir Tidak Valid', 'Waktu berakhir diskon harus di masa depan jika diatur.', 'warning');
                    return;
                }
            }

            const newConfig = {
                isActive: isActive,
                percentage: percentage,
                targetType: targetType,
                targetProducts: targetProducts,
                targetUsers: targetUsers,
                countdownEndTime: countdownEndTime
            };

            try {
                await updateDoc(doc(configCol, "global_settings"), { discount: newConfig });
                showModal('Berhasil!', 'Pengaturan diskon berhasil disimpan!', 'success');
            } catch (error) {
                console.error("Error saving discount config:", error.message);
                showModal('Gagal Simpan', 'Terjadi kesalahan saat menyimpan pengaturan diskon.', 'error');
            }
        }
        window.saveDiscountConfig = saveDiscountConfig;

        // --- FUNGSI COUNTDOWN ---
        function startCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            const currentDiscountConfig = discountConfig;
            const countdownSection = document.getElementById('discountCountdownSection');
            const countdownTimer = document.getElementById('countdownTimer');
            const countdownMessage = document.getElementById('countdownMessage');

            if (!countdownSection || !countdownTimer || !countdownMessage) {
                return;
            }

            if (!currentDiscountConfig.isActive || !currentDiscountConfig.countdownEndTime) {
                countdownSection.style.display = 'none';
                return;
            }

            const endTime = new Date(currentDiscountConfig.countdownEndTime).getTime();
            countdownSection.style.display = 'block';

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    countdownTimer.textContent = "00:00:00:00";
                    countdownTimer.classList.remove('upcoming', 'active');
                    countdownTimer.classList.add('expired');
                    countdownMessage.textContent = "Penawaran spesial telah berakhir!";
                    
                    saveDiscountConfigToFirestore({
                      isActive: false,
                      percentage: 0, // Reset percentage
                      targetType: 'all', // Reset target type
                      targetProducts: [], // Reset target products
                      targetUsers: '', // Reset target users
                      countdownEndTime: null
                    });
                    showModal('Diskon Berakhir!', 'Penawaran spesial telah berakhir. Harga kembali normal.', 'warning');
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownTimer.textContent = 
                    `${days.toString().padStart(2, '0')}:` +
                    `${hours.toString().padStart(2, '0')}:` +
                    `${minutes.toString().padStart(2, '0')}:` +
                    `${seconds.toString().padStart(2, '0')}`;
                
                countdownTimer.classList.remove('expired', 'upcoming');
                countdownTimer.classList.add('active');

                if (distance < (1000 * 60 * 60 * 24)) {
                    countdownMessage.textContent = "Buruan! Tinggal kurang dari sehari!";
                    countdownTimer.classList.add('warning');
                } else {
                    countdownMessage.textContent = "Jangan sampai ketinggalan!";
                }

            }, 1000);
        }
        window.startCountdown = startCountdown;

        // --- FUNGSI MAINTENANCE MODE YANG DIPERBARUI ---
        function toggleMaintenanceFields() {
            const maintenanceStatus = document.getElementById('maintenanceStatus');
            const maintenanceSettingsFields = document.getElementById('maintenanceSettingsFields');
            const maintenanceEndTimeHelperText = document.getElementById('maintenanceEndTimeHelperText'); // Get the helper text element

            if (maintenanceStatus && maintenanceSettingsFields) {
                maintenanceSettingsFields.style.display = maintenanceStatus.checked ? 'block' : 'none';
                // Update helper text based on checkbox state
                if (maintenanceEndTimeHelperText) {
                    maintenanceEndTimeHelperText.textContent = maintenanceStatus.checked ? 
                        'Maintenance akan otomatis berakhir setelah waktu ini.' : 
                        'Waktu berakhir tidak relevan saat maintenance nonaktif.';
                }
            }
        }
        window.toggleMaintenanceFields = toggleMaintenanceFields;

        function loadMaintenanceConfig() {
            const currentMaintenanceConfig = maintenanceConfig;
            const maintenanceStatusToggle = document.getElementById('maintenanceStatus');
            const maintenanceReason = document.getElementById('maintenanceReason');
            const maintenanceDuration = document.getElementById('maintenanceDuration');
            const maintenanceEndTime = document.getElementById('maintenanceEndTime');
            const maintenanceSettingsFields = document.getElementById('maintenanceSettingsFields');

            if (maintenanceStatusToggle) maintenanceStatusToggle.checked = currentMaintenanceConfig.isActive;
            if (maintenanceReason) maintenanceReason.value = currentMaintenanceConfig.reason || '';
            if (maintenanceDuration) maintenanceDuration.value = currentMaintenanceConfig.estimatedDuration || '';
            
            if (maintenanceEndTime && currentMaintenanceConfig.endTime) {
                const date = new Date(currentMaintenanceConfig.endTime);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                maintenanceEndTime.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            } else if (maintenanceEndTime) {
                maintenanceEndTime.value = '';
            }

            if (maintenanceSettingsFields) {
                maintenanceSettingsFields.style.display = currentMaintenanceConfig.isActive ? 'block' : 'none';
            }
            // Call this to update the helper text on load
            toggleMaintenanceFields();
        }
        window.loadMaintenanceConfig = loadMaintenanceConfig;

        async function saveMaintenanceConfig() {
            const maintenanceStatus = document.getElementById('maintenanceStatus');
            const maintenanceReason = document.getElementById('maintenanceReason');
            const maintenanceDuration = document.getElementById('maintenanceDuration');
            const maintenanceEndTime = document.getElementById('maintenanceEndTime');

            if (!maintenanceStatus || !maintenanceReason || !maintenanceDuration || !maintenanceEndTime) return;

            const isActive = maintenanceStatus.checked;
            const reason = maintenanceReason.value.trim();
            const estimatedDuration = maintenanceDuration.value.trim();
            let endTimeValue = maintenanceEndTime.value;
            let endTime = endTimeValue ? new Date(endTimeValue).toISOString() : null;

            // If maintenance is being deactivated, explicitly set endTime to null
            if (!isActive) {
                endTime = null;
            }

            if (isActive) {
                if (!reason) {
                    showModal('Input Kosong', 'Harap masukkan alasan maintenance yang akan ditampilkan ke pengguna.', 'warning');
                    return;
                }
                if (!estimatedDuration) {
                    showModal('Input Kosong', 'Harap masukkan perkiraan durasi maintenance yang akan ditampilkan ke pengguna.', 'warning');
                    return;
                }
                // Only validate endTime if it's active and a value is provided
                if (endTime && new Date(endTime).getTime() <= new Date().getTime()) {
                    showModal('Waktu Berakhir Tidak Valid', 'Waktu berakhir maintenance harus di masa depan jika diatur.', 'warning');
                    return;
                }
            }

            const newConfig = {
                isActive: isActive,
                startTime: isActive ? new Date().toISOString() : null, // Set startTime only if activating
                endTime: endTime,
                reason: reason,
                estimatedDuration: estimatedDuration
            };

            try {
                // Hentikan interval countdown maintenance yang sedang berjalan sebelum menyimpan konfigurasi baru
                if (maintenanceCountdownInterval) {
                    clearInterval(maintenanceCountdownInterval);
                    maintenanceCountdownInterval = null;
                }

                await updateDoc(doc(configCol, "global_settings"), { maintenance: newConfig });
                showModal('Berhasil!', `Mode pemeliharaan ${isActive ? 'diaktifkan' : 'dinonaktifkan'}.`, 'success');
            } catch (error) {
                console.error("Error saving maintenance config:", error.message);
                showModal('Gagal Simpan', 'Terjadi kesalahan saat menyimpan pengaturan pemeliharaan.', 'error');
            }
        }
        window.saveMaintenanceConfig = saveMaintenanceConfig;

        function startMaintenanceCountdown() {
            if (maintenanceCountdownInterval) {
                clearInterval(maintenanceCountdownInterval);
                maintenanceCountdownInterval = null;
            }

            const currentMaintenanceConfig = maintenanceConfig;
            const maintenanceCountdownElement = document.getElementById('maintenanceCountdown');
            const maintenanceReasonElement = document.getElementById('maintenanceReason');

            if (!maintenanceCountdownElement || !maintenanceReasonElement) return;

            if (!currentMaintenanceConfig.isActive || !currentMaintenanceConfig.endTime) {
                maintenanceCountdownElement.style.display = 'none';
                maintenanceReasonElement.style.display = 'none';
                return;
            }

            const endTime = new Date(currentMaintenanceConfig.endTime).getTime();
            maintenanceCountdownElement.style.display = 'block';
            maintenanceReasonElement.style.display = 'block';

            if (currentMaintenanceConfig.reason) {
                maintenanceReasonElement.innerHTML = `<strong>Alasan Maintenance:</strong><br>${currentMaintenanceConfig.reason}`;
            } else {
                maintenanceReasonElement.innerHTML = '';
            }

            maintenanceCountdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(maintenanceCountdownInterval);
                    maintenanceCountdownInterval = null;
                    maintenanceCountdownElement.textContent = "Maintenance selesai!";
                    
                    // Otomatis nonaktifkan maintenance jika waktu habis di Firestore
                    saveMaintenanceConfigToFirestore({
                        isActive: false,
                        endTime: null
                    });
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                maintenanceCountdownElement.textContent = 
                    `Perkiraan waktu selesai: ${hours} jam ${minutes} menit ${seconds} detik`;
                
            }, 1000);
        }

        async function saveMaintenanceConfigToFirestore(updates) {
            try {
                await updateDoc(doc(configCol, "global_settings"), { maintenance: updates });
                console.log("Maintenance config updated in Firestore.");
            } catch (error) {
                console.error("Error saving maintenance config:", error.message);
                showModal('Gagal Simpan', 'Terjadi kesalahan saat menyimpan pengaturan maintenance.', 'error');
            }
        }

        function checkMaintenanceModeAndRedirect() {
            const currentMaintenanceConfig = maintenanceConfig;
            const maintenanceOverlay = document.getElementById('maintenanceOverlay');
            const appContent = document.getElementById('appContent');
            const maintenanceCountdownElement = document.getElementById('maintenanceCountdown');
            const maintenanceReasonElement = document.getElementById('maintenanceReason');
            const isAdminLoggedIn = (currentUser && currentUser.isAdmin === true);

            if (currentMaintenanceConfig.isActive && !isAdminLoggedIn) {
                if (appContent) {
                    appContent.style.display = 'none';
                }
                if (maintenanceOverlay) {
                    maintenanceOverlay.style.display = 'flex';
                }
                if (maintenanceCountdownElement && maintenanceReasonElement) {
                    if (currentMaintenanceConfig.reason) {
                        maintenanceReasonElement.innerHTML = `<strong>Alasan Maintenance:</strong><br>${currentMaintenanceConfig.reason}`;
                    } else {
                        maintenanceReasonElement.innerHTML = '';
                    }
                    
                    if (currentMaintenanceConfig.estimatedDuration) {
                        maintenanceCountdownElement.textContent = `Perkiraan durasi: ${currentMaintenanceConfig.estimatedDuration}`;
                    } else {
                        maintenanceCountdownElement.textContent = '';
                    }
                }
                
                // Mulai countdown jika ada waktu berakhir
                if (currentMaintenanceConfig.endTime) {
                    startMaintenanceCountdown();
                }
            } else {
                if (appContent) { 
                    appContent.style.display = 'block';
                }
                if (maintenanceOverlay) {
                    maintenanceOverlay.style.display = 'none';
                }
                if (maintenanceCountdownInterval) {
                    clearInterval(maintenanceCountdownInterval);
                    maintenanceCountdownInterval = null;
                }
            }
            
            // SELALU tampilkan tombol admin login jika dalam maintenance mode
            if (currentMaintenanceConfig.isActive) {
                const adminLoginBtn = document.querySelector('.hidden-admin-login');
                if (adminLoginBtn) {
                    adminLoginBtn.style.display = 'block';
                }
            } else {
                // Sembunyikan tombol admin login jika tidak dalam maintenance mode
                const adminLoginBtn = document.querySelector('.hidden-admin-login');
                if (adminLoginBtn) {
                    adminLoginBtn.style.display = 'none';
                }
            }
        }
        window.checkMaintenanceModeAndRedirect = checkMaintenanceModeAndRedirect;

        // --- Inisialisasi saat halaman dimuat ---
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthLinks();
            checkMaintenanceModeAndRedirect();
            showPage('home');
        });
    </script>
</body>
</html>
