<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modpack GTA San Andreas (Artivive Studio)</title>

    <style>
        /* style.css content starts here */

        :root {
            --bg-dark: #1a1a1a;
            --bg-medium: #2a2a2a;
            --bg-light: #3a3a3a;
            --text-light: #f0f0f0;
            --text-medium: #b0b0b0;
            --accent-color: #007bff; /* Biru cerah */
            --accent-hover: #0056b3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --border-color: #4a4a4a;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --warning-color: #ffc107; /* Kuning untuk peringatan */
            --discount-color: #00ff00; /* Hijau terang untuk diskon */
            --old-price-color: #888; /* Warna abu-abu untuk harga lama */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            /* New background image and properties */
            background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTVf-uHwce9_0v5XWvwPciP1JSmeEXw99EfCQ&s');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .container {
            background-color: var(--bg-medium);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 20px var(--shadow-color);
            width: 100%;
            max-width: 900px;
            margin: 30px auto;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        header {
            background-color: var(--bg-light);
            width: 100%;
            padding: 15px 0;
            box-shadow: 0 2px 10px var(--shadow-color);
            margin-bottom: 20px;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap; /* Untuk responsif */
        }

        nav a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        nav a:hover, nav a.active {
            background-color: var(--accent-color);
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-medium);
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        input[type="datetime-local"], /* Tambahan untuk datetime-local */
        textarea,
        select {
            width: calc(100% - 22px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-light);
            color: var(--text-light);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        input[type="number"]:focus,
        input[type="datetime-local"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        button {
            background-color: var(--accent-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }

        .product-card {
            background-color: var(--bg-light);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px var(--shadow-color);
        }

        .product-card img {
            max-width: 100%;
            height: 180px;
            object-fit: contain;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .product-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .product-card p {
            color: var(--text-medium);
            margin-bottom: 15px;
        }

        .product-card button {
            width: 100%;
            margin-top: auto; /* Push button to bottom */
        }

        /* Harga Diskon */
        .price-info {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--old-price-color);
            margin-right: 8px;
            font-size: 0.9em;
        }

        .discounted-price {
            color: var(--discount-color);
            font-weight: bold;
        }

        .discount-tag {
            background-color: var(--success-color);
            color: white;
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }


        /* Admin Specific */
        .admin-section {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 20px;
            min-height: 600px; /* Ensure content pushes footer down */
        }

        .admin-sidebar {
            flex: 0 0 200px; /* Fixed width for sidebar */
            background-color: var(--bg-light);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .admin-sidebar h3 {
            text-align: left;
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .admin-sidebar-nav li {
            margin-bottom: 10px;
        }

        .admin-sidebar-nav a {
            display: block;
            color: var(--text-light);
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .admin-sidebar-nav a:hover {
            background-color: var(--bg-medium);
        }

        .admin-sidebar-nav a.active {
            background-color: var(--accent-color);
            color: white;
            font-weight: bold;
        }

        .admin-content {
            flex: 1; /* Take remaining space */
            background-color: var(--bg-light);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .admin-content > div {
            display: none; /* Hide all content sections by default */
        }

        .admin-content > div.active {
            display: block; /* Show active content section */
        }

        .admin-section h3 {
            text-align: left;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            color: var(--accent-color);
        }

        .code-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-color);
            color: var(--text-medium);
        }

        .code-list-item:last-child {
            border-bottom: none;
        }

        .code-list-item .status {
            font-weight: bold;
            color: var(--success-color);
        }

        .code-list-item .status.used {
            color: var(--error-color);
        }

        /* Product Management Table */
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .product-table th, .product-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .product-table th {
            background-color: var(--bg-medium);
            color: var(--accent-color);
            font-weight: bold;
        }

        .product-table tr:hover {
            background-color: var(--bg-medium);
        }

        .product-table img {
            max-width: 50px;
            max-height: 50px;
            border-radius: 5px;
            object-fit: cover;
        }

        /* User Management Table */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .user-table th {
            background-color: var(--bg-medium);
            color: var(--accent-color);
            font-weight: bold;
        }

        .user-table tr:hover {
            background-color: var(--bg-medium);
        }

        .user-table .admin-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .user-table .action-btn, .product-table .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            font-size: 0.9em;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .user-table .make-admin-btn, .product-table .edit-btn {
            background-color: var(--success-color);
        }

        .user-table .remove-admin-btn {
            background-color: var(--warning-color);
        }

        .user-table .delete-user-btn, .product-table .delete-btn {
            background-color: var(--error-color);
        }

        .user-table .action-btn:hover, .product-table .action-btn:hover {
            opacity: 0.9;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                margin: 15px;
                padding: 20px;
            }
            header nav {
                flex-direction: column;
                gap: 10px;
            }
            header nav a {
                width: fit-content;
                margin: 0 auto;
            }
            
            .admin-section {
                flex-direction: column;
            }

            .admin-sidebar {
                flex: 0 0 auto; /* Allow sidebar to take full width */
                width: 100%;
            }

            .admin-content {
                flex: 1;
                width: 100%;
            }

            .user-table, .product-table, .profile-table, .purchase-approval-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap; /* Prevent text wrapping in table cells */
            }
            .user-table thead, .product-table thead, .profile-table thead, .purchase-approval-table thead {
                display: none; /* Hide table headers on small screens */
            }
            .user-table tr, .product-table tr, .profile-table tr, .purchase-approval-table tr {
                display: block;
                margin-bottom: 10px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 10px;
            }
            .user-table td, .product-table td, .profile-table td, .purchase-approval-table td::before {
                display: block;
                text-align: right;
                padding: 5px 0;
                border-bottom: none;
            }
            .user-table td::before, .product-table td::before, .profile-table td::before, .purchase-approval-table td::before {
                content: attr(data-label);
                float: left;
                font-weight: bold;
                color: var(--accent-color);
                margin-right: 10px;
            }
            .user-table td:last-child, .product-table td:last-child, .profile-table td:last-child, .purchase-approval-table td:last-child {
                border-bottom: none;
            }
        }

        /* --- Custom Pop-up (Modal) --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s forwards;
        }

        .modal-content {
            background-color: var(--bg-medium);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            animation: slideIn 0.3s forwards;
            position: relative; /* For close button positioning */
        }

        .modal-content.error {
            border-color: var(--error-color);
        }

        .modal-content.success {
            border-color: var(--success-color);
        }

        .modal-content.warning {
            border-color: var(--warning-color);
        }

        .modal h2 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .modal p {
            color: var(--text-light);
            margin-bottom: 15px;
            font-size: 1.1em;
            word-break: break-all; /* For long codes/IDs */
        }

        .modal strong {
            color: var(--text-light);
            font-size: 1.2em;
            background-color: var(--bg-light);
            padding: 8px 15px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px 0;
            border: 1px dashed var(--border-color);
        }

        .modal button {
            margin: 10px 5px;
        }

        .close-button {
            color: var(--text-medium);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--error-color);
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* --- Live Sale Notification --- */
        .sale-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: var(--bg-light);
            color: var(--text-light);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 999;
            display: flex;
            align-items: center;
            opacity: 0; /* Hidden by default */
            transform: translateX(-100%); /* Start off-screen */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .sale-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .sale-notification p {
            margin: 0;
            font-size: 1.05em;
            display: flex;
            align-items: center;
        }

        .sale-notification .sale-icon {
            font-size: 1.5em;
            margin-right: 10px;
            color: var(--success-color); /* Atau warna lain yang menarik */
        }

        /* --- Top Products List --- */
        .top-products-list {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 30px;
        }

        .top-products-list h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
        }

        .top-products-list ol {
            list-style: none; /* Remove default numbering */
            padding: 0;
            counter-reset: top-product-counter; /* Initialize counter */
        }

        .top-products-list li {
            counter-increment: top-product-counter; /* Increment counter for each list item */
            background-color: var(--bg-light);
            margin-bottom: 10px;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            padding-left: 50px; /* Make space for the number */
        }

        .top-products-list li::before {
            content: counter(top-product-counter);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--accent-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .top-products-list li strong {
            color: var(--text-light);
            font-size: 1.1em;
        }

        .top-products-list li span {
            color: var(--text-medium);
            margin-left: auto; /* Push count to the right */
            font-weight: bold;
        }

        /* --- Discount Countdown --- */
        .discount-countdown-section {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--bg-light);
            border-radius: 8px;
            box-shadow: 0 4px 10px var(--shadow-color);
            text-align: center;
        }

        .countdown-timer {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--discount-color);
            margin-top: 15px;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .countdown-timer.expired {
            color: var(--error-color);
        }

        .countdown-timer.upcoming {
            color: var(--warning-color);
        }

        /* --- Maintenance Mode Overlay --- */
        .maintenance-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Darker overlay */
            color: var(--text-light);
            z-index: 2000; /* Higher than other modals */
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            overflow-y: auto; /* Enable scrolling */
        }

        .maintenance-content {
            background-color: var(--bg-medium);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px var(--shadow-color);
            max-width: 600px;
            border: 2px solid var(--warning-color);
            margin: 50px 0; /* Add margin for scrolling */
        }

        .maintenance-content h1 {
            color: var(--warning-color);
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .maintenance-content p {
            font-size: 1.2em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .maintenance-countdown {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--warning-color);
            margin: 20px 0;
        }

        .maintenance-reason {
            background-color: var(--bg-light);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--warning-color);
        }

        /* Hidden Admin Login */
        .hidden-admin-login {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 3px;
        }

        .hidden-admin-login:hover {
            color: rgba(255, 255, 255, 0.8);
            background-color: rgba(0, 0, 0, 0.8);
        }

        .admin-secret-login {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-dark);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            z-index: 3000;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .admin-secret-login h2 {
            color: var(--warning-color);
            margin-top: 0;
            text-align: center;
        }

        .admin-secret-login .form-group {
            margin-bottom: 15px;
        }

        .admin-secret-login input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 5px;
        }

        .admin-secret-login button {
            width: 100%;
            padding: 10px;
            background-color: var(--warning-color);
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-secret-login button:hover {
            background-color: #e0a800;
        }

        /* Profile Page Specific Styles */
        .profile-section {
            background-color: var(--bg-light);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .profile-section h3 {
            text-align: left;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .profile-info p {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        .profile-info strong {
            color: var(--accent-color);
        }

        .profile-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .profile-table th, .profile-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-medium);
        }

        .profile-table th {
            background-color: var(--bg-medium);
            color: var(--text-light);
            font-weight: bold;
        }

        .profile-table tr:hover {
            background-color: var(--bg-medium);
        }

        .profile-table .status-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .profile-table .status-badge.used {
            background-color: var(--error-color);
            color: white;
        }

        .profile-table .status-badge.available {
            background-color: var(--success-color);
            color: white;
        }

        .profile-table .status-badge.expired {
            background-color: var(--warning-color);
            color: #333;
        }

        .profile-table .copy-code-btn {
            background-color: var(--accent-color);
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
        }

        .profile-table .copy-code-btn:hover {
            background-color: var(--accent-hover);
        }

        .profile-table .warning-message {
            color: var(--text-light);
        }

        /* Purchase Approval Table */
        .purchase-approval-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .purchase-approval-table th, .purchase-approval-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .purchase-approval-table th {
            background-color: var(--bg-medium);
            color: var(--accent-color);
            font-weight: bold;
        }

        .purchase-approval-table tr:hover {
            background-color: var(--bg-medium);
        }

        /* New styles for Product Detail Modal */
        .product-detail-modal-content {
            background-color: var(--bg-medium);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            animation: slideIn 0.3s forwards;
            position: relative;
        }

        .product-detail-modal-content img {
            max-width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .product-detail-modal-content h2 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        .product-detail-modal-content .price-info {
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .product-detail-modal-content .product-description {
            text-align: left;
            color: var(--text-medium);
            margin-bottom: 25px;
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve line breaks from textarea */
        }

        .product-detail-modal-content button {
            width: auto;
            min-width: 150px;
            margin: 10px auto;
        }

        @media (max-width: 600px) {
            .product-detail-modal-content {
                padding: 20px;
            }
            .product-detail-modal-content h2 {
                font-size: 1.8em;
            }
            .product-detail-modal-content .price-info {
                font-size: 1.1em;
            }
            .product-detail-modal-content .product-description {
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="#" id="navHome">Beranda</a>
            <span id="authLinks">
                <a href="#" id="navLogin">Login</a>
                <a href="#" id="navRegister">Register</a>
            </span>
            <span id="loggedInLinks" style="display:none;">
                <a href="#" id="navProfile">Profil</a>
                <a href="#" id="navAdmin">Admin Panel</a>
                <a href="#" id="navLogout">Logout</a>
            </span>
        </nav>
    </header>

    <main class="container" id="appContent">
    </main>

    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="modalCloseButton">&times;</span>
            <h2 id="modalTitle"></h2>
            <p id="modalMessage"></p>
            <div id="modalAttachment" style="margin-top: 15px; text-align: center;"></div>
            <button id="modalCopyButton" style="display:none;"></button>
            <button id="mainModalCloseButton">Tutup</button>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productDetailModal" class="modal">
        <div class="product-detail-modal-content">
            <span class="close-button" id="productDetailCloseButton">&times;</span>
            <h2 id="detailProductName"></h2>
            <img id="detailProductImage" src="" alt="Gambar Produk">
            <p class="price-info">
                <span id="detailOriginalPrice" class="original-price" style="display:none;"></span>
                <span id="detailDiscountedPrice" class="discounted-price"></span>
                <span id="detailDiscountTag" class="discount-tag" style="display:none;"></span>
            </p>
            <h3>Fitur Modpack:</h3>
            <p id="detailProductDescription" class="product-description"></p>
            <button id="detailBuyButton">Beli Sekarang</button>
        </div>
    </div>

    <div id="saleNotification" class="sale-notification">
        <p><span class="sale-icon">💰</span> <span id="saleMessage"></span></p>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content warning">
            <span class="close-button" id="confirmationCloseButton">&times;</span>
            <h2>Konfirmasi Pembelian</h2>
            <p id="confirmationMessage"></p>
            <button id="confirmPurchaseBtn">Ya, Beli</button>
            <button id="cancelPurchaseBtn">Batal</button>
        </div>
    </div>

    <div id="maintenanceOverlay" class="maintenance-overlay" style="display:none;">
        <div class="maintenance-content">
            <h1>🚧 Sedang Dalam Pemeliharaan 🚧</h1>
            <div id="maintenanceCountdown" class="maintenance-countdown"></div>
            <div id="maintenanceReason" class="maintenance-reason"></div>
            <p>Kami sedang melakukan perbaikan dan pembaruan untuk meningkatkan pengalaman Anda.</p>
            <p>Mohon maaf atas ketidaknyamananannya. Kami akan segera kembali!</p>
            <p>Terima kasih atas kesabaran Anda -ArtiviveTeam....</p>
        </div>
    </div>

    <div class="hidden-admin-login" id="hiddenAdminLogin">Login for admin</div>

    <div id="adminSecretLogin" class="admin-secret-login">
        <h2>🔐 Admin Secret Login</h2>
        <div class="form-group">
            <input type="email" id="adminSecretEmail" placeholder="Admin Email">
        </div>
        <div class="form-group">
            <input type="password" id="adminSecretPassword" placeholder="Admin Password">
        </div>
        <div class="form-group">
            <input type="text" id="adminSecretCode" placeholder="Secret Admin Code">
        </div>
        <button id="adminSecretLoginBtn">Login</button>
        <p id="adminSecretLoginError" style="color: var(--error-color); text-align: center; margin-top: 10px;"></p>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="editProductCloseButton">&times;</span>
            <h2>✏️ Edit Produk</h2>
            <input type="hidden" id="editProductId">
            <div class="form-group">
                <label for="editProductName">Nama Produk:</label>
                <input type="text" id="editProductName" placeholder="Nama Produk">
            </div>
            <div class="form-group">
                <label for="editProductPrice">Harga (IDR):</label>
                <input type="number" id="editProductPrice" placeholder="Harga">
            </div>
            <div class="form-group">
                <label for="editProductImage">URL Gambar Produk (Opsional):</label>
                <input type="text" id="editProductImage" placeholder="URL Gambar. Contoh: https://i.imgur.com/modpack_gta.png">
                <img id="editProductImagePreview" src="" alt="Pratinjau Gambar" style="max-width: 100px; max-height: 100px; margin-top: 10px; display: none; border-radius: 5px;">
            </div>
            <div class="form-group">
                <label for="editProductDownloadUrl">URL Unduhan Modpack:</label>
                <input type="text" id="editProductDownloadUrl" placeholder="URL Unduhan">
            </div>
            <div class="form-group">
                <label for="editProductDescription">Deskripsi/Fitur Modpack:</label>
                <textarea id="editProductDescription" rows="5" placeholder="Masukkan deskripsi atau fitur modpack di sini."></textarea>
            </div>
            <button id="updateProductBtn">Simpan Perubahan</button>
            <button id="cancelEditProductBtn" style="background-color: var(--error-color);">Batal</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDS4lE6XNKK_98l7nj807HzXc2WA4zUeHU",
            authDomain: "coderedeemdriftjik.firebaseapp.com",
            projectId: "coderedeemdriftjik",
            storageBucket: "coderedeemdriftjik.appspot.com",
            messagingSenderId: "106368540191",
            appId: "1:106368540191:web:6674e3e46e8c5b9405bf2a",
            measurementId: "G-0JDXJT6L42"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider(); // Google Auth Provider

        // Firestore collection references
        const productsCol = collection(db, "products");
        const usersCol = collection(db, "users");
        const purchasesCol = collection(db, "purchases");
        const configCol = collection(db, "config");
        const warningsCol = collection(db, "warnings");

        // Global state variables
        let allProducts = {};
        let allUsers = {};
        let allPurchases = {};
        let discountConfig = {};
        let maintenanceConfig = {
            isActive: false,
            startTime: null,
            endTime: null,
            reason: "",
            estimatedDuration: ""
        };
        let adminLockConfig = { isActive: false, allowedAdminEmails: [] };
        let currentUser = null;
        let countdownInterval = null;
        let maintenanceCountdownInterval = null;
        let userPurchases = {};
        let userWarnings = {};

        // Secret admin code
        const SECRET_ADMIN_CODE = "6748303865593375593_573=47.6,;'584`~";

        // =========================================================================
        // REAL-TIME FIRESTORE LISTENERS
        // =========================================================================

        onSnapshot(productsCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                    allProducts[change.doc.id] = { ...change.doc.data(), id: change.doc.id };
                }
                if (change.type === "removed") {
                    delete allProducts[change.doc.id];
                }
            });
            console.log("Products updated:", allProducts);
            if (document.getElementById('productGrid')) displayProducts();
            if (document.getElementById('discountProductSelect')) populateDiscountProductSelect();
            if (document.getElementById('allProductsList')) displayProductsAdmin();
            displayTopSellingProducts();
        });

        onSnapshot(usersCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                    allUsers[change.doc.id] = { ...change.doc.data(), id: change.doc.id };
                }
                if (change.type === "removed") {
                    delete allUsers[change.doc.id];
                }
            });
            console.log("Users updated:", allUsers);
            if (currentUser && allUsers[currentUser.uid]) {
                currentUser = { ...currentUser, ...allUsers[currentUser.uid] };
                updateAuthLinks();
                checkMaintenanceModeAndRedirect();
                if (document.getElementById('userProfileContent')) displayUserProfileContent();
            }
            if (document.getElementById('userManagementSection')) displayAllUsers();
            if (document.getElementById('warningTargetUsers')) populateUserSelectForWarning();
        });

        onSnapshot(purchasesCol, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                    allPurchases[change.doc.id] = { ...change.doc.data(), id: change.doc.id };
                    if (currentUser && change.doc.data().userId === currentUser.uid) {
                        userPurchases[change.doc.id] = { ...change.doc.data(), id: change.doc.id };
                    }
                }
                if (change.type === "removed") {
                    delete allPurchases[change.doc.id];
                    if (currentUser && userPurchases[change.doc.id]) {
                        delete userPurchases[change.doc.id];
                    }
                }
            });
            console.log("Purchases updated:", allPurchases);
            console.log("User Purchases updated:", userPurchases);
            displayTopSellingProducts();
            if (document.getElementById('userProfileContent')) displayUserProfileContent();
        });

        const globalSettingsDocRef = doc(configCol, "global_settings");
        onSnapshot(globalSettingsDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                discountConfig = data.discount || {};
                maintenanceConfig = data.maintenance || {
                    isActive: false, startTime: null, endTime: null, reason: "", estimatedDuration: ""
                };
                console.log("Global config updated:", discountConfig, maintenanceConfig);
                displayProducts();
                startCountdown();
                checkMaintenanceModeAndRedirect();
                loadDiscountConfig();
                loadMaintenanceConfig();
            } else {
                console.log("Global settings document does not exist, initializing default.");
                setDoc(globalSettingsDocRef, {
                    discount: { isActive: false, percentage: 10, targetType: 'all', targetProducts: [], targetUsers: '', countdownEndTime: null },
                    maintenance: { isActive: false, startTime: null, endTime: null, reason: "", estimatedDuration: "" }
                });
            }
        });

        const adminSettingsDocRef = doc(configCol, "admin_settings");
        onSnapshot(adminSettingsDocRef, (docSnap) => {
            if (docSnap.exists()) {
                adminLockConfig = docSnap.data().adminLock || { isActive: false, allowedAdminEmails: [] };
                console.log("Admin lock config updated:", adminLockConfig);
            } else {
                console.log("Admin settings document does not exist, initializing default.");
                setDoc(adminSettingsDocRef, { adminLock: adminLockConfig });
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Firebase Auth User:", user.uid, user.email);
                const userDocSnap = await getDoc(doc(usersCol, user.uid));

                if (userDocSnap.exists() && userDocSnap.data().isAdmin === true) {
                    if (adminLockConfig.isActive && !adminLockConfig.allowedAdminEmails.includes(user.email)) {
                        await signOut(auth);
                        showModal('Akses Ditolak', 'Akun admin terkunci. Email ini tidak memiliki izin untuk login.', 'error');
                        showPage('home');
                        return;
                    }
                }
                
                if (userDocSnap.exists()) {
                    currentUser = { ...user, ...userDocSnap.data() };
                    if (typeof currentUser.coins === 'undefined') {
                        await updateDoc(doc(usersCol, user.uid), { coins: 0 });
                        currentUser.coins = 0;
                    }
                } else {
                    await setDoc(doc(usersCol, user.uid), {
                        username: user.email,
                        isAdmin: false,
                        createdAt: new Date().toISOString(),
                        coins: 0
                    });
                    currentUser = { ...user, username: user.email, isAdmin: false, coins: 0 };
                }
                console.log("Current User (Firebase Auth + Firestore):", currentUser);
                updateAuthLinks();
                checkMaintenanceModeAndRedirect();
                setupWarningListener(currentUser.uid);
                setupUserPurchasesListener(currentUser.uid);
            } else {
                currentUser = null;
                console.log("User logged out.");
                updateAuthLinks();
                checkMaintenanceModeAndRedirect();
                if (window.warningUnsubscribe) {
                    window.warningUnsubscribe();
                    window.warningUnsubscribe = null;
                }
                if (window.userPurchasesUnsubscribe) {
                    window.userPurchasesUnsubscribe();
                    window.userPurchasesUnsubscribe = null;
                    userPurchases = {};
                }
                userWarnings = {};
            }
            if (document.getElementById('userProfileContent')) displayUserProfileContent();
        });
        
        function setupUserPurchasesListener(userId) {
            if (window.userPurchasesUnsubscribe) {
                window.userPurchasesUnsubscribe();
            }
            const q = query(purchasesCol, where("userId", "==", userId));
            window.userPurchasesUnsubscribe = onSnapshot(q, (snapshot) => {
                userPurchases = {};
                snapshot.forEach(doc => {
                    userPurchases[doc.id] = { ...doc.data(), id: doc.id };
                });
                console.log("User-specific purchases updated:", userPurchases);
                if (document.getElementById('userProfileContent')) displayUserProfileContent();
            });
        }

        function setupWarningListener(userId) {
            if (window.warningUnsubscribe) {
                window.warningUnsubscribe();
            }
            const q = query(warningsCol, where('isRead.' + userId, '==', false));
            window.warningUnsubscribe = onSnapshot(q, (snapshot) => {
                userWarnings = {};
                snapshot.forEach(doc => {
                    const warningData = { ...doc.data(), id: doc.id };
                    const isGlobal = !warningData.targetUserIds || warningData.targetUserIds.length === 0;
                    const isTargeted = warningData.targetUserIds && warningData.targetUserIds.includes(userId);
                    if ((isGlobal || isTargeted) && !warningData.isRead[userId]) {
                        displayWarningModal(warningData);
                    }
                });
                console.log("User-specific warnings updated:", userWarnings);
                if (document.getElementById('userProfileContent')) {
                    displayUserProfileContent();
                }
            });
            console.log("Warning listener set up for user:", userId);
        }

        function showAdminSecretLogin() {
            const adminLogin = document.getElementById('adminSecretLogin');
            adminLogin.style.display = 'block';
            if (!adminLogin.querySelector('.close-button')) {
                const closeBtn = document.createElement('span');
                closeBtn.className = 'close-button';
                closeBtn.innerHTML = '&times;';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '20px';
                closeBtn.onclick = hideAdminSecretLogin;
                adminLogin.appendChild(closeBtn);
            }
        }
        
        function hideAdminSecretLogin() {
            document.getElementById('adminSecretLogin').style.display = 'none';
            document.getElementById('adminSecretEmail').value = '';
            document.getElementById('adminSecretPassword').value = '';
            document.getElementById('adminSecretCode').value = '';
            document.getElementById('adminSecretLoginError').textContent = '';
        }

        async function verifyAdminSecretLogin() {
            const email = document.getElementById('adminSecretEmail').value.trim();
            const password = document.getElementById('adminSecretPassword').value.trim();
            const secretCode = document.getElementById('adminSecretCode').value.trim();
            const errorElement = document.getElementById('adminSecretLoginError');

            if (!email || !password || !secretCode) {
                errorElement.textContent = 'Harap isi semua field!';
                return;
            }

            if (secretCode !== SECRET_ADMIN_CODE) {
                errorElement.textContent = 'Kode admin tidak valid!';
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(usersCol, userCredential.user.uid));
                
                if (userDoc.exists() && userDoc.data().isAdmin === true) {
                    if (adminLockConfig.isActive && !adminLockConfig.allowedAdminEmails.includes(email)) {
                        await signOut(auth);
                        errorElement.textContent = 'Admin Lock aktif. Email ini tidak diizinkan.';
                        return;
                    }

                    showModal('Login Berhasil!', `Selamat datang, <strong>${userCredential.user.email}</strong>! Anda adalah admin!`, 'success');
                    hideAdminSecretLogin();
                    showPage('admin');
                } else {
                    await signOut(auth);
                    errorElement.textContent = 'Akun ini bukan admin atau tidak memiliki akses!';
                }
            } catch (error) {
                console.error("Error logging in:", error.message);
                let errorMessage = "Terjadi kesalahan saat login.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Email atau password salah.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                }
                errorElement.textContent = errorMessage;
            }
        }

        const DUMMY_BUYER_NAMES = ["CJ", "Big Smoke", "Ryder", "Sweet", "Kendl", "Tenpenny", "Pulaski", "Madd Dogg", "Woozie", "Cesar"];

        function showModal(title, message, type = 'success', textToCopy = '', attachmentHtml = '', allowClose = true) {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalCopyButton = document.getElementById('modalCopyButton');
            const modalAttachment = document.getElementById('modalAttachment');
            const closeButton = document.getElementById('modalCloseButton');
            const mainCloseButton = document.getElementById('mainModalCloseButton');

            modal.querySelector('.modal-content').className = `modal-content ${type}`;
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalAttachment.innerHTML = attachmentHtml;

            if (textToCopy) {
                modalCopyButton.style.display = 'inline-block';
                modalCopyButton.textContent = 'Salin Teks';
                modalCopyButton.onclick = () => {
                    document.execCommand('copy', false, textToCopy);
                    showModal('Berhasil Disalin!', 'Teks berhasil disalin ke clipboard Anda.', 'success');
                };
            } else {
                modalCopyButton.style.display = 'none';
            }

            if (closeButton) closeButton.style.display = allowClose ? 'block' : 'none';
            if (mainCloseButton) mainCloseButton.style.display = allowClose ? 'inline-block' : 'none';

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
            document.getElementById('modalAttachment').innerHTML = '';
        }

        async function displayWarningModal(warningData) {
            const modalTitle = "Peringatan Admin!";
            let modalMessage = `<p>${warningData.message}</p>`;
            let attachmentHtml = '';

            if (warningData.fileUrl) {
                const fileExtension = warningData.fileUrl.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                    attachmentHtml = `<img src="${warningData.fileUrl}" alt="Lampiran" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px;">`;
                } else {
                    attachmentHtml = `<p><a href="${warningData.fileUrl}" target="_blank" style="color: var(--accent-color); text-decoration: underline;">Lihat Lampiran Dokumen</a></p>`;
                }
            }

            showModal(modalTitle, modalMessage, 'warning', '', attachmentHtml);

            if (currentUser) {
                const warningDocRef = doc(warningsCol, warningData.id);
                const currentReadBy = warningData.isRead || {};
                currentReadBy[currentUser.uid] = true;
                await updateDoc(warningDocRef, { isRead: currentReadBy });
                console.log(`Warning ${warningData.id} marked as read by ${currentUser.uid}`);
            }
        }
        
        function showSaleNotification(productName) {
            const notificationDiv = document.getElementById('saleNotification');
            const saleMessageSpan = document.getElementById('saleMessage');

            const randomBuyer = DUMMY_BUYER_NAMES[Math.floor(Math.random() * DUMMY_BUYER_NAMES.length)];
            saleMessageSpan.textContent = `${randomBuyer} baru saja membeli ${productName}!`;

            notificationDiv.classList.add('show');

            setTimeout(() => {
                notificationDiv.classList.remove('show');
            }, 5000);
        }

        function generatePurchaseId() {
            const timestamp = Date.now().toString(36).substring(0, 8);
            const randomPart1 = Math.random().toString(36).substring(2, 8);
            const randomPart2 = Math.random().toString(36).substring(2, 7);
            return `PUR-${timestamp}-${randomPart1}-${randomPart2}`.toUpperCase();
        }

        function updateAuthLinks() {
            const authLinks = document.getElementById('authLinks');
            const loggedInLinks = document.getElementById('loggedInLinks');
            
            if (currentUser) {
                authLinks.style.display = 'none';
                loggedInLinks.style.display = 'inline-block';
            } else {
                authLinks.style.display = 'inline-block';
                loggedInLinks.style.display = 'none';
            }
        }

        async function logoutUser() {
            try {
                await signOut(auth);
                showModal('Logout Berhasil', 'Anda telah berhasil keluar dari akun.', 'success');
                showPage('home');
            } catch (error) {
                console.error("Error logging out:", error.message);
                showModal('Logout Gagal', 'Terjadi kesalahan saat logout.', 'error');
            }
        }

        function showPage(pageName) {
            const appContent = document.getElementById('appContent');
            
            document.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`nav a#nav${pageName.charAt(0).toUpperCase() + pageName.slice(1)}`);
            if (activeLink) activeLink.classList.add('active');

            const isAdminLoggedIn = (currentUser && currentUser.isAdmin === true);
            const maintenanceOverlay = document.getElementById('maintenanceOverlay');

            if (maintenanceConfig.isActive && !isAdminLoggedIn && pageName !== 'home') {
                maintenanceOverlay.style.display = 'flex';
                appContent.innerHTML = '';
                return;
            } else {
                maintenanceOverlay.style.display = 'none';
            }

            let htmlContent = '';
            switch (pageName) {
                case 'home':
                    htmlContent = `
                        <h1>🎮 Beli Modpack GTA San Andreas 💰</h1>
                        <p>Dapatkan modpack terbaik untuk pengalaman bermain GTA San Andreas yang lebih seru!</p>
                        <div id="discountCountdownSection" class="discount-countdown-section" style="display:none;">
                            <h2>Penawaran Spesial Berakhir Dalam!</h2>
                            <div class="countdown-timer" id="countdownTimer"></div>
                            <p id="countdownMessage"></p>
                        </div>
                        <div class="product-grid" id="productGrid">
                            </div>
                        <div class="top-products-list" id="topProductsList">
                            </div>
                    `;
                    appContent.innerHTML = htmlContent;
                    displayProducts();
                    displayTopSellingProducts();
                    startCountdown();
                    break;

                case 'login':
                    if (currentUser) {
                        showModal('Sudah Login', `Anda sudah login sebagai ${currentUser.email}. Silakan logout terlebih dahulu jika ingin login dengan akun lain.`, 'warning');
                        return;
                    }
                    htmlContent = `
                        <h2>Login</h2>
                        <div class="form-group">
                            <label for="loginEmail">Email:</label>
                            <input type="email" id="loginEmail" placeholder="Masukkan email Anda">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" placeholder="Masukkan password Anda">
                        </div>
                        <button id="loginUserBtn">Login</button>
                        <div style="text-align:center; margin-top:20px;">
                            <button id="googleSignInBtn" style="background-color:#4285F4; color:white;">
                                <img src="https://www.gstatic.com/images/branding/product/1x/gsa_48dp.png" alt="Google" style="width:20px; height:20px; vertical-align:middle; margin-right:8px;">
                                Masuk dengan Google
                            </button>
                        </div>
                        <p style="text-align:center; margin-top:20px; color:var(--text-medium);">Belum punya akun? <a href="#" id="navRegisterLink">Daftar di sini</a></p>
                    `;
                    appContent.innerHTML = htmlContent;
                    document.getElementById('loginUserBtn').addEventListener('click', loginUser);
                    document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);
                    document.getElementById('navRegisterLink').addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage('register');
                    });
                    break;

                case 'register':
                    if (currentUser) {
                        showModal('Sudah Login', `Anda sudah login sebagai ${currentUser.email}. Silakan logout terlebih dahulu jika ingin daftar akun baru.`, 'warning');
                        return;
                    }
                    htmlContent = `
                        <h2>Register Akun Baru</h2>
                        <div class="form-group">
                            <label for="regEmail">Email:</label>
                            <input type="email" id="regEmail" placeholder="Gunakan email Anda sebagai username">
                        </div>
                        <div class="form-group">
                            <label for="regPassword">Password:</label>
                            <input type="password" id="regPassword" placeholder="Buat password Anda (minimal 6 karakter)">
                        </div>
                        <button id="registerUserBtn">Daftar</button>
                        <p style="text-align:center; margin-top:20px; color:var(--text-medium);">Sudah punya akun? <a href="#" id="navLoginLink">Login di sini</a></p>
                    `;
                    appContent.innerHTML = htmlContent;
                    document.getElementById('registerUserBtn').addEventListener('click', registerUser);
                    document.getElementById('navLoginLink').addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage('login');
                    });
                    break;
                
                case 'profile':
                    if (!currentUser) {
                        showModal('Akses Ditolak', 'Anda harus login untuk melihat profil Anda.', 'error');
                        showPage('login');
                        return;
                    }
                    htmlContent = `
                        <div id="userProfileContent">
                            <h2>👤 Profil Pengguna</h2>
                            <div class="profile-section">
                                <h3>Informasi Akun</h3>
                                <p class="profile-info">Email: <strong>${currentUser.email || 'N/A'}</strong></p>
                                <p class="profile-info">ID Pengguna: <small>${currentUser.uid}</small></p>
                            </div>

                            <div class="profile-section">
                                <h3>Diskon Aktif</h3>
                                <div id="activeDiscountInfo">
                                    <!-- Active discount will be loaded here -->
                                    <p style="color:var(--text-medium);">Tidak ada diskon aktif saat ini.</p>
                                </div>
                            </div>

                            <div class="profile-section">
                                <h3>Riwayat Pembelian Modpack</h3>
                                <div id="purchaseHistoryList">
                                    <!-- Purchase history will be loaded here -->
                                    <p style="color:var(--text-medium);">Anda belum melakukan pembelian.</p>
                                </div>
                            </div>

                            <div class="profile-section">
                                <h3>Peringatan dari Admin</h3>
                                <div id="userWarningsList">
                                    <!-- User-specific warnings will be loaded here -->
                                    <p style="color:var(--text-medium);">Tidak ada peringatan baru.</p>
                                </div>
                            </div>
                        </div>
                    `;
                    appContent.innerHTML = htmlContent;
                    displayUserProfileContent();
                    break;

                case 'admin':
                    if (!currentUser || !currentUser.isAdmin) {
                        showModal('Akses Ditolak', 'Anda tidak memiliki izin untuk mengakses halaman admin.', 'error');
                        showPage('home');
                        return;
                    }
                    htmlContent = `
                        <h2>🛠️ Panel Admin 🔒</h2>
                        <p style="text-align:center; color:var(--text-medium);">Kelola produk, dan pengguna di sini.</p>

                        <div class="admin-section">
                            <aside class="admin-sidebar">
                                <h3>Navigasi Admin</h3>
                                <ul class="admin-sidebar-nav">
                                    <li><a href="#" id="adminNavUsers" class="active">Manajemen Pengguna</a></li>
                                    <li><a href="#" id="adminNavProducts">Manajemen Produk</a></li>
                                    <li><a href="#" id="adminNavDiscounts">Pengaturan Diskon & Lock</a></li>
                                    <li><a href="#" id="adminNavMaintenance">Mode Pemeliharaan</a></li>
                                    <li><a href="#" id="adminNavWarnings">Kirim Peringatan</a></li>
                                </ul>
                            </aside>
                            <section class="admin-content">
                                <div id="adminUsers" class="admin-content-section active">
                                    <h3>Manajemen Pengguna</h3>
                                    <div class="form-group">
                                        <label for="newUserEmail">Email Pengguna Baru:</label>
                                        <input type="email" id="newUserEmail" placeholder="Masukkan email pengguna baru">
                                    </div>
                                    <div class="form-group">
                                        <label for="newUserPassword">Password:</label>
                                        <input type="password" id="newUserPassword" placeholder="Buat password untuk pengguna">
                                    </div>
                                    <div class="form-group">
                                        <label for="newUserIsAdmin">Jenis Akun:</label>
                                        <select id="newUserIsAdmin">
                                            <option value="false">Pengguna Biasa</option>
                                            <option value="true">Admin</option>
                                        </select>
                                    </div>
                                    <button id="createUserFromAdminBtn">Buat Akun</button>
                                    <h3 style="margin-top: 30px;">Daftar Semua Pengguna</h3>
                                    <div id="usersTableContainer">
                                        <!-- Tabel pengguna akan dimuat di sini -->
                                    </div>
                                </div>

                                <div id="adminProducts" class="admin-content-section">
                                    <h3>Tambah Produk Modpack Baru</h3>
                                    <div class="form-group">
                                        <label for="adminProductName">Nama Modpack:</label>
                                        <input type="text" id="adminProductName" placeholder="Contoh: Modpack Ultimate Graphics v2">
                                    </div>
                                    <div class="form-group">
                                        <label for="adminProductPrice">Harga (IDR):</label>
                                        <input type="number" id="adminProductPrice" placeholder="Contoh: 50000">
                                    </div>
                                    <div class="form-group">
                                        <label for="adminProductImage">URL Gambar Produk (Opsional):</label>
                                        <input type="text" id="adminProductImage" placeholder="URL Gambar. Contoh: https://i.imgur.com/modpack_gta.png">
                                        <img id="adminProductImagePreview" src="" alt="Pratinjau Gambar" style="max-width: 100px; max-height: 100px; margin-top: 10px; display: none; border-radius: 5px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="adminProductDownloadUrl">URL Unduhan Modpack:</label>
                                        <input type="text" id="adminProductDownloadUrl" placeholder="Contoh: https://link.mediafire.com/modpack_v2">
                                    </div>
                                    <div class="form-group">
                                        <label for="adminProductDescription">Deskripsi/Fitur Modpack:</label>
                                        <textarea id="adminProductDescription" rows="5" placeholder="Masukkan deskripsi atau fitur modpack di sini."></textarea>
                                    </div>
                                    <button id="addProductBtn">Tambah Produk</button>
                                    <h3 style="margin-top: 30px;">Daftar Semua Produk Modpack</h3>
                                    <div id="allProductsList">
                                        <!-- Product list will be loaded here -->
                                        <p style="text-align:center; color:var(--text-medium);">Memuat produk...</p>
                                    </div>
                                </div>

                                <div id="adminDiscounts" class="admin-content-section">
                                    <h3 style="margin-top: 0;">💰 Pengaturan Diskon 💰</h3>
                                    <div class="form-group">
                                        <label for="discountStatus">Status Diskon:</label>
                                        <input type="checkbox" id="discountStatus"> Aktifkan Diskon
                                    </div>
                                    <div id="discountSettingsFields" style="display: none;">
                                        <div class="form-group">
                                            <label for="discountPercentage">Persentase Diskon (%):</label>
                                            <input type="number" id="discountPercentage" min="1" max="100" value="10">
                                        </div>
                                        <div class="form-group">
                                            <label for="discountCountdownEndTime">Waktu Berakhir Diskon (Opsional):</label>
                                            <input type="datetime-local" id="discountCountdownEndTime">
                                            <small style="color:var(--text-medium);">Diskon akan otomatis nonaktif setelah waktu ini.</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="discountTargetType">Target Diskon:</label>
                                            <select id="discountTargetType">
                                                <option value="all">Semua Produk</option>
                                                <option value="specific">Produk Tertentu</option>
                                            </select>
                                        </div>
                                        <div class="form-group" id="discountSpecificProductSelect" style="display: none;">
                                            <label for="discountProductSelect">Pilih Produk (CTRL+klik untuk pilih banyak):</label>
                                            <select id="discountProductSelect" multiple size="5"></select>
                                        </div>
                                        <div class="form-group">
                                            <label for="discountTargetUsers">Target Pengguna (pisahkan dengan koma, kosongkan untuk semua):</label>
                                            <input type="text" id="discountTargetUsers" placeholder="contoh: user1@email.com, user2@email.com">
                                        </div>
                                        <button id="saveDiscountConfigBtn">Simpan Pengaturan Diskon</button>
                                    </div>

                                    <h3 style="margin-top: 30px;">🔒 Admin Lock 🔒</h3>
                                    <div class="form-group">
                                        <label for="adminLockStatus">Status Admin Lock:</label>
                                        <input type="checkbox" id="adminLockStatus"> Aktifkan Kunci Admin
                                    </div>
                                    <div class="form-group">
                                        <label for="allowedAdminEmails">Email Admin yang Diizinkan (pisahkan dengan koma):</label>
                                        <input type="text" id="allowedAdminEmails" placeholder="contoh: admin1@email.com, admin2@email.com">
                                        <small style="color:var(--text-medium);">Hanya email ini yang dapat login sebagai admin jika fitur ini aktif.</small>
                                    </div>
                                    <button id="saveAdminLockConfigBtn">Simpan Pengaturan Admin</button>
                                </div>

                                <div id="adminMaintenance" class="admin-content-section">
                                    <h3 style="margin-top: 0;">🚧 Pengaturan Maintenance Mode 🚧</h3>
                                    <div class="form-group">
                                        <label for="maintenanceStatus">Status Maintenance Mode:</label>
                                        <input type="checkbox" id="maintenanceStatus"> Aktifkan Mode Pemeliharaan
                                    </div>
                                    <div id="maintenanceSettingsFields" style="display: none;">
                                        <div class="form-group">
                                            <label for="maintenanceReason">Alasan Maintenance (Ditampilkan ke Pengguna):</label>
                                            <textarea id="maintenanceReason" rows="3" placeholder="Contoh: Sedang melakukan update sistem pembayaran..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="maintenanceDuration">Perkiraan Durasi (Ditampilkan ke Pengguna):</label>
                                            <input type="text" id="maintenanceDuration" placeholder="Contoh: 2 jam, 30 menit">
                                        </div>
                                        <div class="form-group">
                                            <label for="maintenanceEndTime">Waktu Berakhir Maintenance (Opsional):</label>
                                            <input type="datetime-local" id="maintenanceEndTime">
                                            <small id="maintenanceEndTimeHelperText" style="color:var(--text-medium);">Maintenance akan otomatis berakhir setelah waktu ini.</small>
                                        </div>
                                        <button id="saveMaintenanceConfigBtn">Simpan Pengaturan Maintenance</button>
                                        <button id="stopMaintenanceBtn" style="background-color: var(--error-color); margin-top: 10px;">Stop Maintenance Sekarang</button>
                                    </div>
                                </div>

                                <div id="adminWarnings" class="admin-content-section">
                                    <h3 style="margin-top: 0;">📢 Kirim Peringatan ke Pengguna 📢</h3>
                                    <div class="form-group">
                                        <label for="warningMessage">Pesan Peringatan:</label>
                                        <textarea id="warningMessage" rows="5" placeholder="Tulis pesan peringatan di sini..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="warningFileUrl">URL Gambar/Dokumen (Opsional):</label>
                                        <input type="text" id="warningFileUrl" placeholder="Contoh: https://i.imgur.com/warning.png atau https://example.com/document.pdf">
                                        <small style="color:var(--text-medium);">Masukkan URL langsung ke gambar atau dokumen. Untuk upload file, Anda memerlukan layanan penyimpanan seperti Firebase Storage.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="warningTargetUsers">Target Pengguna (pilih satu atau lebih, kosongkan untuk semua pengguna):</label>
                                        <select id="warningTargetUsers" multiple size="5"></select>
                                        <small style="color:var(--text-medium);">Tekan CTRL (Windows) / Command (Mac) untuk memilih beberapa pengguna.</small>
                                    </div>
                                    <button id="sendWarningBtn">Kirim Peringatan</button>
                                </div>
                            </section>
                        </div>
                    `;
                    appContent.innerHTML = htmlContent;
                    bindAdminEvents();
                    showAdminSection('adminUsers', document.querySelector('nav a#adminNavUsers'));
                    break;
                default:
                    showPage('home');
                    break;
            }
            checkMaintenanceModeAndRedirect();
        }
        
        function bindAdminEvents() {
            document.getElementById('adminNavUsers').addEventListener('click', (e) => { e.preventDefault(); showAdminSection('adminUsers', e.target); });
            document.getElementById('adminNavProducts').addEventListener('click', (e) => { e.preventDefault(); showAdminSection('adminProducts', e.target); });
            document.getElementById('adminNavDiscounts').addEventListener('click', (e) => { e.preventDefault(); showAdminSection('adminDiscounts', e.target); });
            document.getElementById('adminNavMaintenance').addEventListener('click', (e) => { e.preventDefault(); showAdminSection('adminMaintenance', e.target); });
            document.getElementById('adminNavWarnings').addEventListener('click', (e) => { e.preventDefault(); showAdminSection('adminWarnings', e.target); });

            document.getElementById('createUserFromAdminBtn').addEventListener('click', createUserFromAdmin);
            document.getElementById('addProductBtn').addEventListener('click', addProduct);
            
            const editProductImage = document.getElementById('editProductImage');
            if(editProductImage) { editProductImage.addEventListener('input', () => displayImagePreview('editProductImage', 'editProductImagePreview')); }

            const adminProductImage = document.getElementById('adminProductImage');
            if(adminProductImage) { adminProductImage.addEventListener('input', () => displayImagePreview('adminProductImage', 'adminProductImagePreview')); }

            const discountStatus = document.getElementById('discountStatus');
            if(discountStatus) { discountStatus.addEventListener('change', toggleDiscountFields); }

            const discountTargetType = document.getElementById('discountTargetType');
            if(discountTargetType) { discountTargetType.addEventListener('change', toggleDiscountTargetProductSelect); }
            
            document.getElementById('saveDiscountConfigBtn').addEventListener('click', saveDiscountConfig);
            
            const maintenanceStatus = document.getElementById('maintenanceStatus');
            if(maintenanceStatus) { maintenanceStatus.addEventListener('change', toggleMaintenanceFields); }

            document.getElementById('saveMaintenanceConfigBtn').addEventListener('click', saveMaintenanceConfig);
            document.getElementById('stopMaintenanceBtn').addEventListener('click', stopMaintenance);
            
            document.getElementById('sendWarningBtn').addEventListener('click', sendWarning);

            const updateProductBtn = document.getElementById('updateProductBtn');
            if(updateProductBtn) { updateProductBtn.addEventListener('click', updateProduct); }
            const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
            if(cancelEditProductBtn) { cancelEditProductBtn.addEventListener('click', closeEditProductModal); }
        }

        function showAdminSection(sectionId, clickedLink) {
            document.querySelectorAll('.admin-content-section').forEach(section => {
                section.classList.remove('active');
            });

            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.admin-sidebar-nav a').forEach(link => {
                link.classList.remove('active');
            });

            if (clickedLink) {
                clickedLink.classList.add('active');
            }

            switch (sectionId) {
                case 'adminUsers':
                    displayAllUsers();
                    break;
                case 'adminProducts':
                    displayProductsAdmin();
                    break;
                case 'adminDiscounts':
                    loadDiscountConfig();
                    populateDiscountProductSelect();
                    loadAdminLockConfig(); // Load Admin Lock settings
                    break;
                case 'adminMaintenance':
                    loadMaintenanceConfig();
                    break;
                case 'adminWarnings':
                    populateUserSelectForWarning();
                    break;
            }
        }
        
        async function createUserFromAdmin() {
            const emailInput = document.getElementById('newUserEmail');
            const passwordInput = document.getElementById('newUserPassword');
            const isAdminSelect = document.getElementById('newUserIsAdmin');
            
            if (!emailInput || !passwordInput || !isAdminSelect) return;
            
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const isAdmin = isAdminSelect.value === 'true';
            
            if (!email || !password) {
                showModal('Input Kosong', 'Email dan password tidak boleh kosong.', 'warning');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                await setDoc(doc(usersCol, userCredential.user.uid), {
                    username: email,
                    isAdmin: isAdmin,
                    createdAt: new Date().toISOString()
                });
                
                showModal('Berhasil!', `Akun ${email} berhasil dibuat sebagai ${isAdmin ? 'Admin' : 'Pengguna Biasa'}.`, 'success');
                
                emailInput.value = '';
                passwordInput.value = '';
                isAdminSelect.value = 'false';
                
            } catch (error) {
                console.error("Error creating user:", error.message);
                let errorMessage = "Terjadi kesalahan saat membuat akun.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email ini sudah terdaftar.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password terlalu lemah (minimal 6 karakter).";
                }
                showModal('Gagal Membuat Akun', errorMessage, 'error');
            }
        }

        async function displayAllUsers() {
            const usersTableContainer = document.getElementById('usersTableContainer');
            if (!usersTableContainer) return;
            
            try {
                const querySnapshot = await getDocs(usersCol);
                
                let html = `
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Tanggal Dibuat</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const userId = doc.id;
                    
                    if (currentUser && userId === currentUser.uid) {
                        return;
                    }
                    
                    const createdAt = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString('id-ID') : '-';
                    
                    html += `
                        <tr>
                            <td data-label="Email">${userData.username || '-'}</td>
                            <td data-label="Status">
                                ${userData.isAdmin ? '<span class="admin-badge">Admin</span>' : 'Pengguna'}
                            </td>
                            <td data-label="Tanggal Dibuat">${createdAt}</td>
                            <td data-label="Aksi">
                                ${!userData.isAdmin ?
                                    `<button class="action-btn make-admin-btn" data-user-id="${userId}">Jadikan Admin</button>` :
                                    `<button class="action-btn remove-admin-btn" data-user-id="${userId}">Hapus Admin</button>`
                                }
                                <button class="action-btn delete-user-btn" data-user-id="${userId}">Hapus</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                usersTableContainer.innerHTML = html;
                
                // Bind events for dynamically loaded buttons
                usersTableContainer.querySelectorAll('.make-admin-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => toggleAdminStatus(e.target.dataset.userId, true));
                });
                usersTableContainer.querySelectorAll('.remove-admin-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => toggleAdminStatus(e.target.dataset.userId, false));
                });
                usersTableContainer.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => deleteUser(e.target.dataset.userId));
                });
                
            } catch (error) {
                console.error("Error fetching users:", error);
                usersTableContainer.innerHTML = '<p style="color: var(--error-color);">Gagal memuat daftar pengguna.</p>';
            }
        }

        async function toggleAdminStatus(userId, makeAdmin) {
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            const confirmationMessage = document.getElementById('confirmationMessage');

            confirmationModal.querySelector('.modal-content').className = 'modal-content warning';
            confirmationMessage.innerHTML = `Apakah Anda yakin ingin ${makeAdmin ? 'menjadikan' : 'menghapus status admin'} pengguna ini?`;
            confirmationModal.style.display = 'flex';

            confirmPurchaseBtn.onclick = async () => {
                try {
                    await updateDoc(doc(usersCol, userId), {
                        isAdmin: makeAdmin
                    });
                    showModal('Berhasil!', `Status admin berhasil ${makeAdmin ? 'diberikan' : 'dihapus'}.`, 'success');
                    displayAllUsers();
                } catch (error) {
                    console.error("Error updating admin status:", error);
                    showModal('Gagal!', 'Terjadi kesalahan saat mengubah status admin.', 'error');
                } finally {
                    hideConfirmation();
                }
            };

            cancelPurchaseBtn.onclick = () => {
                showModal('Dibatalkan', 'Perubahan status admin dibatalkan.', 'warning');
                hideConfirmation();
            };
        }

        async function deleteUser(userId) {
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            const confirmationMessage = document.getElementById('confirmationMessage');

            confirmationModal.querySelector('.modal-content').className = 'modal-content error';
            confirmationMessage.innerHTML = 'Apakah Anda yakin ingin menghapus pengguna ini? Tindakan ini tidak dapat dibatalkan!';
            confirmationModal.style.display = 'flex';

            confirmPurchaseBtn.onclick = async () => {
                try {
                    await deleteDoc(doc(usersCol, userId));
                    showModal('Berhasil!', 'Pengguna berhasil dihapus.', 'success');
                    displayAllUsers();
                } catch (error) {
                    console.error("Error deleting user:", error);
                    showModal('Gagal!', 'Terjadi kesalahan saat menghapus pengguna.', 'error');
                } finally {
                    hideConfirmation();
                }
            };

            cancelPurchaseBtn.onclick = () => {
                showModal('Dibatalkan', 'Penghapusan pengguna dibatalkan.', 'warning');
                hideConfirmation();
            };
        }

        function displayProducts() {
            const productGrid = document.getElementById('productGrid');
            if (!productGrid) return;
            productGrid.innerHTML = '';
            const products = allProducts;
            const currentDiscountConfig = discountConfig;
            const currentLoggedInUser = currentUser;
            
            if (currentDiscountConfig.isActive && currentDiscountConfig.countdownEndTime) {
                const endTime = new Date(currentDiscountConfig.countdownEndTime).getTime();
                const now = new Date().getTime();
                if (now >= endTime) {
                    saveDiscountConfigToFirestore({
                        isActive: false, percentage: 0, targetType: 'all', targetProducts: [], targetUsers: '', countdownEndTime: null
                    });
                    showModal('Diskon Berakhir!', 'Penawaran spesial telah berakhir. Harga kembali normal.', 'warning');
                }
            }

            const productArray = Object.values(products);
            if (productArray.length === 0) {
                productGrid.innerHTML = '<p style="text-align:center; color:var(--text-medium);">Belum ada produk yang tersedia. Silakan tambahkan dari panel admin.</p>';
                return;
            }

            productArray.forEach(product => {
                let displayPrice = product.price;
                let originalPriceHtml = '';
                let discountTag = '';
                let appliedDiscountPercentage = 0;

                if (currentDiscountConfig.isActive) {
                    const isUserTargeted = !currentDiscountConfig.targetUsers || (currentLoggedInUser && currentDiscountConfig.targetUsers.toLowerCase().includes(currentLoggedInUser.email.toLowerCase()));
                    const isProductTargeted =
                        currentDiscountConfig.targetType === 'all' ||
                        (currentDiscountConfig.targetType === 'specific' && currentDiscountConfig.targetProducts.includes(product.id));

                    if (isUserTargeted && isProductTargeted) {
                        appliedDiscountPercentage = currentDiscountConfig.percentage;
                    }
                }

                if (appliedDiscountPercentage > 0) {
                    const discountedPrice = product.price * (1 - appliedDiscountPercentage / 100);
                    originalPriceHtml = `<span class="original-price">Rp ${product.price.toLocaleString('id-ID')}</span>`;
                    displayPrice = discountedPrice;
                    discountTag = `<span class="discount-tag">-${appliedDiscountPercentage}%</span>`;
                }

                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.image || 'https://placehold.co/150x180/2a2a2a/f0f0f0?text=Modpack'}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p class="price-info">
                        ${originalPriceHtml}
                        <span class="discounted-price">${displayPrice === 0 ? 'GRATIS' : `Rp ${displayPrice.toLocaleString('id-ID')}`}</span>
                        ${discountTag}
                    </p>
                    <button class="product-detail-btn" data-product-id="${product.id}">Lihat Detail</button>
                `;
                productGrid.appendChild(productCard);
            });
            // Bind event listeners for dynamically created buttons
            productGrid.querySelectorAll('.product-detail-btn').forEach(btn => {
                btn.addEventListener('click', (e) => showProductDetail(e.target.dataset.productId));
            });
        }

        function showProductDetail(productId) {
            const product = allProducts[productId];
            if (!product) {
                showModal('Error!', 'Produk tidak ditemukan.', 'error');
                return;
            }

            const detailModal = document.getElementById('productDetailModal');
            const detailProductName = document.getElementById('detailProductName');
            const detailProductImage = document.getElementById('detailProductImage');
            const detailOriginalPrice = document.getElementById('detailOriginalPrice');
            const detailDiscountedPrice = document.getElementById('detailDiscountedPrice');
            const detailDiscountTag = document.getElementById('detailDiscountTag');
            const detailProductDescription = document.getElementById('detailProductDescription');
            const detailBuyButton = document.getElementById('detailBuyButton');

            detailProductName.textContent = product.name;
            detailProductImage.src = product.image || 'https://placehold.co/300x200/2a2a2a/f0f0f0?text=Modpack';
            detailProductImage.onerror = () => {
                detailProductImage.src = 'https://placehold.co/300x200/2a2a2a/f0f0f0?text=Gambar+Rusak';
            };

            let displayPrice = product.price;
            let originalPriceHtml = '';
            let discountTag = '';
            let appliedDiscountPercentage = 0;

            if (discountConfig.isActive) {
                const isUserTargeted = !discountConfig.targetUsers || (currentUser && discountConfig.targetUsers.toLowerCase().includes(currentUser.email.toLowerCase()));
                const isProductTargeted =
                    discountConfig.targetType === 'all' ||
                    (discountConfig.targetType === 'specific' && currentDiscountConfig.targetProducts.includes(product.id));

                if (isUserTargeted && isProductTargeted) {
                    appliedDiscountPercentage = discountConfig.percentage;
                }
            }

            if (appliedDiscountPercentage > 0) {
                const discountedPrice = product.price * (1 - appliedDiscountPercentage / 100);
                originalPriceHtml = `Rp ${product.price.toLocaleString('id-ID')}`;
                displayPrice = discountedPrice;
                discountTag = `-${appliedDiscountPercentage}%`;
                detailOriginalPrice.style.display = 'inline';
                detailDiscountTag.style.display = 'inline';
            } else {
                detailOriginalPrice.style.display = 'none';
                detailDiscountTag.style.display = 'none';
            }

            detailOriginalPrice.textContent = originalPriceHtml;
            detailDiscountedPrice.textContent = displayPrice === 0 ? 'GRATIS' : `Rp ${displayPrice.toLocaleString('id-ID')}`;
            detailDiscountTag.textContent = discountTag;
            
            detailProductDescription.textContent = product.description || 'Tidak ada deskripsi tersedia untuk modpack ini.';

            detailBuyButton.addEventListener('click', () => {
                confirmPurchase(productId);
                closeProductDetailModal();
            }, { once: true });

            detailModal.style.display = 'flex';
        }

        function closeProductDetailModal() {
            document.getElementById('productDetailModal').style.display = 'none';
        }

        let currentPurchaseProductId = null;

        function confirmPurchase(productId) {
            const products = allProducts;
            const product = products[productId];
            const currentDiscountConfig = discountConfig;
            const currentLoggedInUser = currentUser;

            if (!product) {
                showModal('Error!', 'Produk tidak ditemukan.', 'error');
                return;
            }

            let finalPrice = product.price;
            let appliedDiscountPercentage = 0;

            if (currentDiscountConfig.isActive) {
                const isUserTargeted = !currentDiscountConfig.targetUsers || (currentLoggedInUser && currentDiscountConfig.targetUsers.toLowerCase().includes(currentLoggedInUser.email.toLowerCase()));
                const isProductTargeted =
                    currentDiscountConfig.targetType === 'all' ||
                    (currentDiscountConfig.targetType === 'specific' && currentDiscountConfig.targetProducts.includes(product.id));

                if (isUserTargeted && isProductTargeted) {
                    appliedDiscountPercentage = currentDiscountConfig.percentage;
                }
            }

            if (appliedDiscountPercentage > 0) {
                finalPrice = product.price * (1 - appliedDiscountPercentage / 100);
            }

            currentPurchaseProductId = productId;
            const priceDisplay = finalPrice === 0 ? 'GRATIS' : `Rp ${finalPrice.toLocaleString('id-ID')}`;
            const message = `Apakah Anda yakin ingin membeli <strong>${product.name}</strong> seharga <strong>${priceDisplay}</strong>?`;
            
            document.getElementById('confirmationMessage').innerHTML = message;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function hideConfirmation() {
            document.getElementById('confirmationModal').style.display = 'none';
            currentPurchaseProductId = null;
        }

        function simulatePurchase(productId) {
            const products = allProducts;
            const product = products[productId];
            if (!product) {
                showModal('Error!', 'Produk tidak ditemukan saat simulasi pembelian.', 'error');
                return;
            }
            if (!product.downloadUrl) {
                showModal('Error!', 'Modpack ini belum memiliki URL unduhan. Silakan hubungi admin.', 'error');
                return;
            }

            const purchaseId = generatePurchaseId();
            const newPurchaseData = {
                productId: productId,
                downloadUrl: product.downloadUrl,
                purchaseDate: new Date().toISOString(),
                userId: currentUser ? currentUser.uid : null,
                productName: product.name,
                productPrice: product.price
            };

            try {
                setDoc(doc(purchasesCol, purchaseId), newPurchaseData);
                console.log("Purchase added to Firestore:", purchaseId);

                showModal('Pembelian Berhasil!', `<p>Terima kasih telah membeli <strong>${product.name}</strong>!</p><p>ID Pembelian Anda: <strong>${purchaseId}</strong></p><p>Tautan Unduhan Anda: <strong><a href="${product.downloadUrl}" target="_blank" style="color: var(--accent-color); text-decoration: underline;">KLIK UNTUK UNDUH</a></strong></p>`, 'success', product.downloadUrl);

                showSaleNotification(product.name);
            } catch (error) {
                console.error("Error simulating purchase:", error.message);
                showModal('Pembelian Gagal', 'Terjadi kesalahan saat memproses pembelian.', 'error');
            }
        }
        
        async function registerUser() {
            const emailInput = document.getElementById('regEmail');
            const passwordInput = document.getElementById('regPassword');
            if (!emailInput || !passwordInput) return;

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showModal('Input Kosong', 'Email dan password tidak boleh kosong.', 'warning');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(usersCol, userCredential.user.uid), {
                    username: email,
                    isAdmin: false,
                    createdAt: new Date().toISOString()
                });

                showModal('Registrasi Berhasil!', `Akun <strong>${email}</strong> berhasil dibuat. Silakan login.`, 'success');
                emailInput.value = '';
                passwordInput.value = '';
                showPage('login');
            } catch (error) {
                console.error("Error registering user:", error.message);
                let errorMessage = "Terjadi kesalahan saat pendaftaran.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email ini sudah terdaftar. Silakan gunakan email lain atau login.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password terlalu lemah (minimal 6 karakter).";
                }
                showModal('Registrasi Gagal', errorMessage, 'error');
            }
        }

        async function loginUser() {
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            if (!emailInput || !passwordInput) return;

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                showModal('Input Kosong', 'Email dan password tidak boleh kosong.', 'warning');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(usersCol, userCredential.user.uid));
                const user = userCredential.user;

                if (userDoc.exists() && userDoc.data().isAdmin === true) {
                    if (adminLockConfig.isActive && !adminLockConfig.allowedAdminEmails.includes(user.email)) {
                        await signOut(auth);
                        showModal('Akses Ditolak', 'Admin Lock aktif. Email ini tidak diizinkan untuk login admin.', 'error');
                        showPage('home');
                        return;
                    }
                    showModal('Login Berhasil!', `Selamat datang, <strong>${user.email}</strong>! Anda adalah admin!`, 'success');
                    setTimeout(() => showPage('admin'), 1000);
                } else {
                    showModal('Login Berhasil!', `Selamat datang, <strong>${user.email}</strong>!`, 'success');
                    setTimeout(() => showPage('home'), 1000);
                }
            } catch (error) {
                console.error("Error logging in:", error.message);
                let errorMessage = "Terjadi kesalahan saat login.";
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Email atau password salah.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Format email tidak valid.";
                }
                showModal('Login Gagal', errorMessage, 'error');
            }
        }
        
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                const userDocRef = doc(usersCol, user.uid);
                const userDocSnap = await getDoc(userDocRef);

                let isNewUser = false;
                if (!userDocSnap.exists()) {
                    isNewUser = true;
                    await setDoc(userDocRef, {
                        username: user.email,
                        isAdmin: false,
                        createdAt: new Date().toISOString()
                    });
                }
                
                if (!isNewUser && userDocSnap.data().isAdmin === true) {
                    if (adminLockConfig.isActive && !adminLockConfig.allowedAdminEmails.includes(user.email)) {
                        await signOut(auth);
                        showModal('Akses Ditolak', 'Admin Lock aktif. Email ini tidak diizinkan untuk login admin.', 'error');
                        showPage('home');
                        return;
                    }
                }

                if (isNewUser) {
                    showModal('Selamat Datang!', 'Akun Anda berhasil dibuat dengan Google.', 'success');
                } else if (userDocSnap.data().isAdmin === true) {
                    showModal('Login Berhasil!', `Selamat datang, <strong>${user.email}</strong>! Anda adalah admin!`, 'success');
                } else {
                    showModal('Login Berhasil!', `Selamat datang kembali, <strong>${user.email}</strong>!`, 'success');
                }
                
                setTimeout(() => showPage('home'), 1000);

            } catch (error) {
                console.error("Error with Google Sign-In:", error.message);
                let errorMessage = "Terjadi kesalahan saat login dengan Google.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Proses login dibatalkan.";
                }
                showModal('Login Gagal', errorMessage, 'error');
            }
        }

        function displayImagePreview(inputId, previewImgId) {
            const urlInput = document.getElementById(inputId);
            const previewImg = document.getElementById(previewImgId);

            if (urlInput.value) {
                previewImg.src = urlInput.value;
                previewImg.style.display = 'block';
                previewImg.onerror = () => {
                    previewImg.src = 'https://placehold.co/100x100/2a2a2a/f0f0f0?text=Gambar+Rusak';
                };
            } else {
                previewImg.src = '';
                previewImg.style.display = 'none';
            }
        }
        
        async function addProduct() {
            const adminProductName = document.getElementById('adminProductName');
            const adminProductPrice = document.getElementById('adminProductPrice');
            const adminProductImage = document.getElementById('adminProductImage');
            const adminProductDownloadUrl = document.getElementById('adminProductDownloadUrl');
            const adminProductDescription = document.getElementById('adminProductDescription');

            if (!adminProductName || !adminProductPrice || !adminProductImage || !adminProductDownloadUrl || !adminProductDescription) return;

            const name = adminProductName.value.trim();
            const price = parseFloat(adminProductPrice.value);
            const imageUrl = adminProductImage.value.trim();
            const downloadUrl = adminProductDownloadUrl.value.trim();
            const description = adminProductDescription.value.trim();

            if (!name || isNaN(price) || price < 0 || !downloadUrl) {
                showModal('Input Tidak Valid', 'Nama produk, harga (tidak boleh negatif), dan URL unduhan harus diisi dengan benar.', 'warning');
                return;
            }

            const productId = name.toLowerCase().replace(/\s/g, '_').replace(/[^a-z0-9_]/g, '');

            const productDoc = await getDoc(doc(productsCol, productId));
            if (productDoc.exists()) {
                showModal('Produk Sudah Ada', 'Produk dengan nama ini sudah ada.', 'error');
                return;
            }

            try {
                await setDoc(doc(productsCol, productId), {
                    id: productId, name: name, price: price, image: imageUrl || 'https://placehold.co/150x180/2a2a2a/f0f0f0?text=Modpack', downloadUrl: downloadUrl, description: description
                });
                console.log("Product added to Firestore:", productId);

                showModal('Berhasil!', `Produk "<strong>${name}</strong>" berhasil ditambahkan!`, 'success');
                adminProductName.value = '';
                adminProductPrice.value = '';
                adminProductImage.value = '';
                document.getElementById('adminProductImagePreview').src = '';
                document.getElementById('adminProductImagePreview').style.display = 'none';
                adminProductDownloadUrl.value = '';
                adminProductDescription.value = '';
            } catch (error) {
                console.error("Error adding product:", error.message);
                showModal('Gagal Menambah Produk', 'Terjadi kesalahan saat menambahkan produk.', 'error');
            }
        }

        async function displayProductsAdmin() {
            const allProductsListDiv = document.getElementById('allProductsList');
            if (!allProductsListDiv) return;

            let html = `<table class="product-table"><thead><tr><th>Gambar</th><th>Nama Produk</th><th>Harga</th><th>URL Unduhan</th><th>Aksi</th></tr></thead><tbody>`;
            const productsArray = Object.values(allProducts);
            if (productsArray.length === 0) {
                html += `<tr><td colspan="5" style="text-align: center;">Belum ada produk yang tersedia.</td></tr>`;
            } else {
                productsArray.forEach(product => {
                    html += `
                        <tr>
                            <td data-label="Gambar"><img src="${product.image || 'https://placehold.co/50x50/2a2a2a/f0f0f0?text=Modpack'}" alt="${product.name}"></td>
                            <td data-label="Nama Produk">${product.name}</td>
                            <td data-label="Harga">${product.price === 0 ? 'GRATIS' : `Rp ${product.price.toLocaleString('id-ID')}`}</td>
                            <td data-label="URL Unduhan"><a href="${product.downloadUrl}" target="_blank" style="color: var(--accent-color); text-decoration: underline;">Link</a></td>
                            <td data-label="Aksi">
                                <button class="action-btn edit-btn" onclick="showEditProductModal('${product.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteProduct('${product.id}')">Hapus</button>
                            </td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table>`;
            allProductsListDiv.innerHTML = html;
        }
        window.displayProductsAdmin = displayProductsAdmin;

        function showEditProductModal(productId) {
            const product = allProducts[productId];
            if (!product) { showModal('Error!', 'Produk tidak ditemukan untuk diedit.', 'error'); return; }
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductDownloadUrl').value = product.downloadUrl || '';
            document.getElementById('editProductDescription').value = product.description || '';
            const editProductImage = document.getElementById('editProductImage');
            const editProductImagePreview = document.getElementById('editProductImagePreview');
            if (product.image) {
                editProductImage.value = product.image;
                editProductImagePreview.src = product.image;
                editProductImagePreview.style.display = 'block';
                editProductImagePreview.onerror = () => { editProductImagePreview.src = 'https://placehold.co/100x100/2a2a2a/f0f0f0?text=Gambar+Rusak'; };
            } else {
                editProductImage.value = '';
                editProductImagePreview.src = '';
                editProductImagePreview.style.display = 'none';
            }
            document.getElementById('editProductModal').style.display = 'flex';
        }
        window.showEditProductModal = showEditProductModal;

        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            document.getElementById('editProductId').value = '';
            document.getElementById('editProductName').value = '';
            document.getElementById('editProductPrice').value = '';
            document.getElementById('editProductImage').value = '';
            document.getElementById('editProductImagePreview').src = '';
            document.getElementById('editProductImagePreview').style.display = 'none';
            document.getElementById('editProductDownloadUrl').value = '';
            document.getElementById('editProductDescription').value = '';
        }
        window.closeEditProductModal = closeEditProductModal;

        async function updateProduct() {
            const productId = document.getElementById('editProductId').value;
            const name = document.getElementById('editProductName').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const imageUrl = document.getElementById('editProductImage').value.trim();
            const downloadUrl = document.getElementById('editProductDownloadUrl').value.trim();
            const description = document.getElementById('editProductDescription').value.trim();

            if (!productId || !name || isNaN(price) || price < 0 || !downloadUrl) {
                showModal('Input Tidak Valid', 'Nama produk, harga (tidak boleh negatif), dan URL unduhan harus diisi dengan benar.', 'warning');
                return;
            }

            try {
                await updateDoc(doc(productsCol, productId), {
                    name: name, price: price, image: imageUrl || 'https://placehold.co/150x180/2a2a2a/f0f0f0?text=Modpack', downloadUrl: downloadUrl, description: description
                });
                showModal('Berhasil!', `Produk "<strong>${name}</strong>" berhasil diperbarui!`, 'success');
                closeEditProductModal();
            } catch (error) {
                console.error("Error updating product:", error.message);
                showModal('Gagal Memperbarui Produk', 'Terjadi kesalahan saat memperbarui produk.', 'error');
            }
        }
        window.updateProduct = updateProduct;

        async function deleteProduct(productId) {
            const product = allProducts[productId];
            if (!product) { showModal('Error!', 'Produk tidak ditemukan untuk dihapus.', 'error'); return; }
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            const confirmationMessage = document.getElementById('confirmationMessage');

            confirmationModal.querySelector('.modal-content').className = 'modal-content error';
            confirmationMessage.innerHTML = `Apakah Anda yakin ingin menghapus produk "<strong>${product.name}</strong>"? Tindakan ini tidak dapat dibatalkan!`;
            confirmationModal.style.display = 'flex';

            confirmPurchaseBtn.onclick = async () => {
                try {
                    await deleteDoc(doc(productsCol, productId));
                    showModal('Berhasil!', `Produk "<strong>${product.name}</strong>" berhasil dihapus.`, 'success');
                } catch (error) {
                    console.error("Error deleting product:", error.message);
                    showModal('Gagal Menghapus Produk', 'Terjadi kesalahan saat menghapus produk.', 'error');
                } finally {
                    hideConfirmation();
                }
            };

            cancelPurchaseBtn.onclick = () => {
                showModal('Dibatalkan', 'Penghapusan produk dibatalkan.', 'warning');
                hideConfirmation();
            };
        }
        window.deleteProduct = deleteProduct;

        function displayTopSellingProducts() {
            const topProductsListDiv = document.getElementById('topProductsList');
            if (!topProductsListDiv) return;
            const purchases = allPurchases;
            const products = allProducts;
            const salesCount = {};
            for (const purchaseId in purchases) {
                const purchase = purchases[purchaseId];
                if (purchase.productId) {
                    salesCount[purchase.productId] = (salesCount[purchase.productId] || 0) + 1;
                }
            }
            const sortedProducts = Object.keys(salesCount)
                .map(productId => ({
                    id: productId, name: products[productId] ? products[productId].name : 'Produk Tidak Dikenal', sales: salesCount[productId]
                }))
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 5);
            let htmlContent = '<h2>🔥 Modpack Terlaris 🔥</h2>';
            if (sortedProducts.length === 0) {
                htmlContent += '<p style="text-align:center; color:var(--text-medium);">Belum ada modpack yang terjual.</p>';
            } else {
                htmlContent += '<ol>';
                sortedProducts.forEach(product => {
                    htmlContent += `<li><strong>${product.name}</strong> <span>Terjual: ${product.sales}</span></li>`;
                });
                htmlContent += '</ol>';
            }
            topProductsListDiv.innerHTML = htmlContent;
        }
        window.displayTopSellingProducts = displayTopSellingProducts;

        function loadDiscountConfig() {
            const currentDiscountConfig = discountConfig;
            const discountStatus = document.getElementById('discountStatus');
            const discountPercentage = document.getElementById('discountPercentage');
            const discountTargetType = document.getElementById('discountTargetType');
            const discountProductSelect = document.getElementById('discountProductSelect');
            const discountTargetUsers = document.getElementById('discountTargetUsers');
            const discountCountdownEndTime = document.getElementById('discountCountdownEndTime');
            const discountSettingsFields = document.getElementById('discountSettingsFields');
            if (discountStatus) discountStatus.checked = currentDiscountConfig.isActive;
            if (discountPercentage) discountPercentage.value = currentDiscountConfig.percentage;
            if (discountTargetType) discountTargetType.value = currentDiscountConfig.targetType;
            if (discountTargetUsers) discountTargetUsers.value = currentDiscountConfig.targetUsers;
            
            if (discountCountdownEndTime && currentDiscountConfig.countdownEndTime) {
                const date = new Date(currentDiscountConfig.countdownEndTime);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                discountCountdownEndTime.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            } else if (discountCountdownEndTime) {
                discountCountdownEndTime.value = '';
            }

            if (discountProductSelect) {
                for (let i = 0; i < discountProductSelect.options.length; i++) {
                    const option = discountProductSelect.options[i];
                    option.selected = currentDiscountConfig.targetProducts && currentDiscountConfig.targetProducts.includes(option.value);
                }
            }
            if (discountSettingsFields) discountSettingsFields.style.display = currentDiscountConfig.isActive ? 'block' : 'none';
            if (document.getElementById('discountSpecificProductSelect')) document.getElementById('discountSpecificProductSelect').style.display = (currentDiscountConfig.isActive && currentDiscountConfig.targetType === 'specific') ? 'block' : 'none';
        }
        window.loadDiscountConfig = loadDiscountConfig;

        function toggleDiscountFields() {
            const discountStatus = document.getElementById('discountStatus');
            const discountSettingsFields = document.getElementById('discountSettingsFields');
            if (discountStatus && discountSettingsFields) {
                discountSettingsFields.style.display = discountStatus.checked ? 'block' : 'none';
                toggleDiscountTargetProductSelect();
            }
        }
        window.toggleDiscountFields = toggleDiscountFields;

        function toggleDiscountTargetProductSelect() {
            const discountTargetType = document.getElementById('discountTargetType');
            const discountSpecificProductSelect = document.getElementById('discountSpecificProductSelect');
            if (discountTargetType && discountSpecificProductSelect) {
                discountSpecificProductSelect.style.display = (discountTargetType.value === 'specific' && document.getElementById('discountStatus').checked) ? 'block' : 'none';
            }
        }
        window.toggleDiscountTargetProductSelect = toggleDiscountTargetProductSelect;

        function populateDiscountProductSelect() {
            const products = allProducts;
            const discountProductSelect = document.getElementById('discountProductSelect');
            if (!discountProductSelect) return;
            discountProductSelect.innerHTML = '';
            for (const productId in products) {
                const option = document.createElement('option');
                option.value = productId;
                option.textContent = products[productId].name;
                discountProductSelect.appendChild(option);
            }
            loadDiscountConfig();
        }
        window.populateDiscountProductSelect = populateDiscountProductSelect;

        async function saveDiscountConfigToFirestore(updates) {
            try {
                await updateDoc(doc(configCol, "global_settings"), { discount: updates });
                console.log("Discount config updated in Firestore.");
            } catch (error) {
                console.error("Error saving discount config:", error.message);
                showModal('Gagal Simpan', 'Terjadi kesalahan saat menyimpan pengaturan diskon.', 'error');
            }
        }

        async function saveDiscountConfig() {
            const discountStatus = document.getElementById('discountStatus');
            const discountPercentage = document.getElementById('discountPercentage');
            const discountTargetType = document.getElementById('discountTargetType');
            const discountProductSelect = document.getElementById('discountProductSelect');
            const discountTargetUsers = document.getElementById('discountTargetUsers');
            const discountCountdownEndTime = document.getElementById('discountCountdownEndTime');

            if (!discountStatus || !discountPercentage || !discountTargetType || !discountProductSelect || !discountTargetUsers || !discountCountdownEndTime) return;

            const isActive = discountStatus.checked;
            const percentage = parseFloat(discountPercentage.value);
            const targetType = discountTargetType.value;
            const targetProducts = [];
            if (targetType === 'specific') {
                for (let i = 0; i < discountProductSelect.options.length; i++) {
                    if (discountProductSelect.options[i].selected) {
                        targetProducts.push(discountProductSelect.options[i].value);
                    }
                }
            }
            const targetUsers = discountTargetUsers.value.trim();
            const endTimeValue = discountCountdownEndTime.value;
            const countdownEndTime = endTimeValue ? new Date(endTimeValue).toISOString() : null;

            if (isActive) {
                if (isNaN(percentage) || percentage <= 0 || percentage > 100) { showModal('Input Tidak Valid', 'Persentase diskon harus antara 1-100.', 'warning'); return; }
                if (targetType === 'specific' && targetProducts.length === 0) { showModal('Pilih Produk', 'Jika target diskon spesifik, pilih setidaknya satu produk.', 'warning'); return; }
                if (countdownEndTime && new Date(countdownEndTime).getTime() <= new Date().getTime()) { showModal('Waktu Berakhir Tidak Valid', 'Waktu berakhir diskon harus di masa depan jika diatur.', 'warning'); return; }
            }

            const newConfig = {
                isActive: isActive,
                percentage: percentage,
                targetType: targetType,
                targetProducts: targetProducts,
                targetUsers: targetUsers,
                countdownEndTime: countdownEndTime
            };

            try {
                await updateDoc(doc(configCol, "global_settings"), { discount: newConfig });
                showModal('Berhasil!', 'Pengaturan diskon berhasil disimpan!', 'success');
            } catch (error) {
                console.error("Error saving discount config:", error.message);
                showModal('Gagal Simpan', 'Terjadi kesalahan saat menyimpan pengaturan diskon.', 'error');
            }
        }
        window.saveDiscountConfig = saveDiscountConfig;

        function startCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            const currentDiscountConfig = discountConfig;
            const countdownSection = document.getElementById('discountCountdownSection');
            const countdownTimer = document.getElementById('countdownTimer');
            const countdownMessage = document.getElementById('countdownMessage');
            if (!countdownSection || !countdownTimer || !countdownMessage) { return; }
            if (!currentDiscountConfig.isActive || !currentDiscountConfig.countdownEndTime) {
                countdownSection.style.display = 'none';
                return;
            }
            const endTime = new Date(currentDiscountConfig.countdownEndTime).getTime();
            countdownSection.style.display = 'block';
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    countdownTimer.textContent = "00:00:00:00";
                    countdownTimer.classList.remove('upcoming', 'active');
                    countdownTimer.classList.add('expired');
                    countdownMessage.textContent = "Penawaran spesial telah berakhir!";
                    saveDiscountConfigToFirestore({
                        isActive: false, percentage: 0, targetType: 'all', targetProducts: [], targetUsers: '', countdownEndTime: null
                    });
                    showModal('Diskon Berakhir!', 'Penawaran spesial telah berakhir. Harga kembali normal.', 'warning');
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                countdownTimer.textContent = `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                countdownTimer.classList.remove('expired', 'upcoming');
                countdownTimer.classList.add('active');
                if (distance < (1000 * 60 * 60 * 24)) {
                    countdownMessage.textContent = "Buruan! Tinggal kurang dari sehari!";
                    countdownTimer.classList.add('warning');
                } else {
                    countdownMessage.textContent = "Jangan sampai ketinggalan!";
                }
            }, 1000);
        }
        window.startCountdown = startCountdown;

        function toggleMaintenanceFields() {
            const maintenanceStatus = document.getElementById('maintenanceStatus');
            const maintenanceSettingsFields = document.getElementById('maintenanceSettingsFields');
            const maintenanceEndTimeHelperText = document.getElementById('maintenanceEndTimeHelperText');
            if (maintenanceStatus && maintenanceSettingsFields) {
                maintenanceSettingsFields.style.display = maintenanceStatus.checked ? 'block' : 'none';
                if (maintenanceEndTimeHelperText) {
                    maintenanceEndTimeHelperText.textContent = maintenanceStatus.checked ? 'Maintenance akan otomatis berakhir setelah waktu ini.' : 'Waktu berakhir tidak relevan saat maintenance nonaktif.';
                }
            }
        }
        window.toggleMaintenanceFields = toggleMaintenanceFields;

        function loadMaintenanceConfig() {
            const currentMaintenanceConfig = maintenanceConfig;
            const maintenanceStatusToggle = document.getElementById('maintenanceStatus');
            const maintenanceReason = document.getElementById('maintenanceReason');
            const maintenanceDuration = document.getElementById('maintenanceDuration');
            const maintenanceEndTime = document.getElementById('maintenanceEndTime');
            const maintenanceSettingsFields = document.getElementById('maintenanceSettingsFields');
            if (maintenanceStatusToggle) maintenanceStatusToggle.checked = currentMaintenanceConfig.isActive;
            if (maintenanceReason) maintenanceReason.value = currentMaintenanceConfig.reason || '';
            if (maintenanceDuration) maintenanceDuration.value = currentMaintenanceConfig.estimatedDuration || '';
            
            if (maintenanceEndTime && currentMaintenanceConfig.endTime) {
                const date = new Date(currentMaintenanceConfig.endTime);
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                maintenanceEndTime.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            } else if (maintenanceEndTime) {
                maintenanceEndTime.value = '';
            }
            if (maintenanceSettingsFields) {
                maintenanceSettingsFields.style.display = currentMaintenanceConfig.isActive ? 'block' : 'none';
            }
            toggleMaintenanceFields();
        }
        window.loadMaintenanceConfig = loadMaintenanceConfig;

        async function saveMaintenanceConfig() {
            const maintenanceStatus = document.getElementById('maintenanceStatus');
            const maintenanceReason = document.getElementById('maintenanceReason');
            const maintenanceDuration = document.getElementById('maintenanceDuration');
            const maintenanceEndTime = document.getElementById('maintenanceEndTime');
            if (!maintenanceStatus || !maintenanceReason || !maintenanceDuration || !maintenanceEndTime) return;
            const isActive = maintenanceStatus.checked;
            const reason = maintenanceReason.value.trim();
            const estimatedDuration = maintenanceDuration.value.trim();
            let endTimeValue = maintenanceEndTime.value;
            let endTime = endTimeValue ? new Date(endTimeValue).toISOString() : null;
            if (!isActive) { endTime = null; }
            if (isActive) {
                if (!reason) { showModal('Input Kosong', 'Harap masukkan alasan maintenance yang akan ditampilkan ke pengguna.', 'warning'); return; }
                if (!estimatedDuration) { showModal('Input Kosong', 'Harap masukkan perkiraan durasi maintenance yang akan ditampilkan ke pengguna.', 'warning'); return; }
                if (endTime && new Date(endTime).getTime() <= new Date().getTime()) { showModal('Waktu Berakhir Tidak Valid', 'Waktu berakhir maintenance harus di masa depan jika diatur.', 'warning'); return; }
            }
            const newConfig = {
                isActive: isActive, startTime: isActive ? new Date().toISOString() : null, endTime: endTime, reason: reason, estimatedDuration: estimatedDuration
            };
            try {
                if (maintenanceCountdownInterval) { clearInterval(maintenanceCountdownInterval); maintenanceCountdownInterval = null; }
                await updateDoc(doc(configCol, "global_settings"), { maintenance: newConfig });
                showModal('Berhasil!', `Mode pemeliharaan ${isActive ? 'diaktifkan' : 'dinonaktifkan'}.`, 'success');
            } catch (error) {
                console.error("Error saving maintenance config:", error.message);
                showModal('Gagal Simpan', 'Terjadi kesalahan saat menyimpan pengaturan pemeliharaan.', 'error');
            }
        }
        window.saveMaintenanceConfig = saveMaintenanceConfig;

        async function stopMaintenance() {
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            const confirmationMessage = document.getElementById('confirmationMessage');
            confirmationModal.querySelector('.modal-content').className = 'modal-content warning';
            confirmationMessage.innerHTML = 'Apakah Anda yakin ingin menghentikan mode pemeliharaan sekarang? Situs akan kembali online.';
            confirmationModal.style.display = 'flex';
            confirmPurchaseBtn.onclick = async () => {
                try {
                    await updateDoc(doc(configCol, "global_settings"), {
                        maintenance: { isActive: false, startTime: null, endTime: null, reason: "", estimatedDuration: "" }
                    });
                    showModal('Berhasil!', 'Mode pemeliharaan telah dihentikan. Situs kembali online!', 'success');
                    setTimeout(() => showPage('home'), 1000);
                } catch (error) {
                    console.error("Error stopping maintenance:", error.message);
                    showModal('Gagal!', 'Terjadi kesalahan saat menghentikan mode pemeliharaan.', 'error');
                } finally { hideConfirmation(); }
            };
            cancelPurchaseBtn.onclick = () => { showModal('Dibatalkan', 'Penghentian mode pemeliharaan dibatalkan.', 'warning'); hideConfirmation(); };
        }
        window.stopMaintenance = stopMaintenance;

        function startMaintenanceCountdown() {
            if (maintenanceCountdownInterval) { clearInterval(maintenanceCountdownInterval); maintenanceCountdownInterval = null; }
            const currentMaintenanceConfig = maintenanceConfig;
            const maintenanceCountdownElement = document.getElementById('maintenanceCountdown');
            const maintenanceReasonElement = document.getElementById('maintenanceReason');
            if (!maintenanceCountdownElement || !maintenanceReasonElement) return;
            if (!currentMaintenanceConfig.isActive || !currentMaintenanceConfig.endTime) {
                maintenanceCountdownElement.style.display = 'none';
                maintenanceReasonElement.style.display = 'none';
                return;
            }
            const endTime = new Date(currentMaintenanceConfig.endTime).getTime();
            maintenanceCountdownElement.style.display = 'block';
            maintenanceReasonElement.style.display = 'block';
            if (currentMaintenanceConfig.reason) { maintenanceReasonElement.innerHTML = `<strong>Alasan Maintenance:</strong><br>${currentMaintenanceConfig.reason}`; } else { maintenanceReasonElement.innerHTML = ''; }
            maintenanceCountdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;
                if (distance < 0) {
                    clearInterval(maintenanceCountdownInterval);
                    maintenanceCountdownInterval = null;
                    maintenanceCountdownElement.textContent = "Maintenance selesai!";
                    saveMaintenanceConfigToFirestore({ isActive: false, endTime: null });
                    return;
                }
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                maintenanceCountdownElement.textContent = `Perkiraan waktu selesai: ${hours} jam ${minutes} menit ${seconds} detik`;
            }, 1000);
        }
        window.startMaintenanceCountdown = startMaintenanceCountdown;

        function checkMaintenanceModeAndRedirect() {
            const currentMaintenanceConfig = maintenanceConfig;
            const maintenanceOverlay = document.getElementById('maintenanceOverlay');
            const appContent = document.getElementById('appContent');
            const maintenanceCountdownElement = document.getElementById('maintenanceCountdown');
            const maintenanceReasonElement = document.getElementById('maintenanceReason');
            const isAdminLoggedIn = (currentUser && currentUser.isAdmin === true);
            if (currentMaintenanceConfig.isActive && !isAdminLoggedIn) {
                if (appContent) { appContent.style.display = 'none'; }
                if (maintenanceOverlay) { maintenanceOverlay.style.display = 'flex'; }
                if (maintenanceCountdownElement && maintenanceReasonElement) {
                    if (currentMaintenanceConfig.reason) { maintenanceReasonElement.innerHTML = `<strong>Alasan Maintenance:</strong><br>${currentMaintenanceConfig.reason}`; } else { maintenanceReasonElement.innerHTML = ''; }
                    if (currentMaintenanceConfig.estimatedDuration) { maintenanceCountdownElement.textContent = `Perkiraan durasi: ${currentMaintenanceConfig.estimatedDuration}`; } else { maintenanceCountdownElement.innerHTML = ''; } // Fixed bug here
                }
                if (currentMaintenanceConfig.endTime) { startMaintenanceCountdown(); }
            } else {
                if (appContent) { appContent.style.display = 'block'; }
                if (maintenanceOverlay) { maintenanceOverlay.style.display = 'none'; }
                if (maintenanceCountdownInterval) { clearInterval(maintenanceCountdownInterval); maintenanceCountdownInterval = null; }
            }
            const adminLoginBtn = document.querySelector('.hidden-admin-login');
            if (adminLoginBtn) { adminLoginBtn.style.display = currentMaintenanceConfig.isActive ? 'block' : 'none'; }
        }
        window.checkMaintenanceModeAndRedirect = checkMaintenanceModeAndRedirect;

        function populateUserSelectForWarning() {
            const warningTargetUsersSelect = document.getElementById('warningTargetUsers');
            if (!warningTargetUsersSelect) return;
            warningTargetUsersSelect.innerHTML = '<option value="">-- Pilih Pengguna (Kosongkan untuk Semua) --</option>';
            const sortedUsers = Object.values(allUsers).sort((a, b) => (a.username || '').localeCompare(b.username || ''));
            sortedUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                warningTargetUsersSelect.appendChild(option);
            });
        }
        window.populateUserSelectForWarning = populateUserSelectForWarning;

        async function sendWarning() {
            const warningMessageInput = document.getElementById('warningMessage');
            const warningFileUrlInput = document.getElementById('warningFileUrl');
            const warningTargetUsersSelect = document.getElementById('warningTargetUsers');
            if (!warningMessageInput || !warningFileUrlInput || !warningTargetUsersSelect) return;
            const message = warningMessageInput.value.trim();
            const fileUrl = warningFileUrlInput.value.trim();
            const selectedUserIds = Array.from(warningTargetUsersSelect.selectedOptions).map(option => option.value);
            if (!message) { showModal('Peringatan Kosong', 'Pesan peringatan tidak boleh kosong.', 'warning'); return; }
            const newWarning = {
                message: message, fileUrl: fileUrl || null, targetUserIds: selectedUserIds, sentAt: new Date().toISOString(), isRead: {}
            };
            try {
                await addDoc(warningsCol, newWarning);
                showModal('Peringatan Terkirim!', 'Peringatan berhasil dikirim ke pengguna yang dipilih (atau semua pengguna).', 'success');
                warningMessageInput.value = '';
                warningFileUrlInput.value = '';
                warningTargetUsersSelect.value = '';
                populateUserSelectForWarning();
            } catch (error) {
                console.error("Error sending warning:", error.message);
                showModal('Gagal Mengirim Peringatan', 'Terjadi kesalahan saat mengirim peringatan.', 'error');
            }
        }
        window.sendWarning = sendWarning;

        function setupGlobalEventListeners() {
            document.getElementById('navHome').addEventListener('click', (e) => { e.preventDefault(); showPage('home'); });
            document.getElementById('navLogin').addEventListener('click', (e) => { e.preventDefault(); showPage('login'); });
            document.getElementById('navRegister').addEventListener('click', (e) => { e.preventDefault(); showPage('register'); });
            document.getElementById('navProfile').addEventListener('click', (e) => { e.preventDefault(); showPage('profile'); });
            const navAdmin = document.getElementById('navAdmin');
            if (navAdmin) { navAdmin.addEventListener('click', (e) => { e.preventDefault(); showPage('admin'); }); }
            const navLogout = document.getElementById('navLogout');
            if (navLogout) { navLogout.addEventListener('click', (e) => { e.preventDefault(); logoutUser(); }); }
            document.getElementById('hiddenAdminLogin').addEventListener('click', showAdminSecretLogin);
            
            document.getElementById('modalCloseButton').addEventListener('click', closeModal);
            document.getElementById('mainModalCloseButton').addEventListener('click', closeModal);
            document.getElementById('productDetailCloseButton').addEventListener('click', closeProductDetailModal);
            document.getElementById('confirmationCloseButton').addEventListener('click', hideConfirmation);
            
            const confirmPurchaseBtn = document.getElementById('confirmPurchaseBtn');
            if (confirmPurchaseBtn) { confirmPurchaseBtn.addEventListener('click', () => { if (currentPurchaseProductId) { simulatePurchase(currentPurchaseProductId); } hideConfirmation(); }); }
            const cancelPurchaseBtn = document.getElementById('cancelPurchaseBtn');
            if (cancelPurchaseBtn) { cancelPurchaseBtn.addEventListener('click', () => { showModal('Pembelian Dibatalkan', 'Anda telah membatalkan pembelian.', 'warning'); hideConfirmation(); }); }
            
            document.getElementById('adminSecretLoginBtn').addEventListener('click', verifyAdminSecretLogin);
            document.getElementById('editProductCloseButton').addEventListener('click', closeEditProductModal);
            document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
            const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
            if (cancelEditProductBtn) { cancelEditProductBtn.addEventListener('click', closeEditProductModal); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupGlobalEventListeners();
            updateAuthLinks();
            checkMaintenanceModeAndRedirect();
            showPage('home');
        });
    </script>
</body>
</html>
